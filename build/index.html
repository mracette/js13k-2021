<html><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1.01"><title>JS13k 2021</title><body class="full"><div id="root" class="full flex flex-centered fill-absolute"><canvas class="centered" id="canvas-pre"></canvas><canvas class="centered" id="canvas-tiles"></canvas><canvas class="centered" id="canvas-instruments"></canvas><canvas class="centered" id="canvas-oscillators"></canvas><canvas class="centered" id="canvas-post"></canvas><canvas class="centered" id="canvas-stats"></canvas><div class="full centered flex flex-centered" id="menu" style="visibility: hidden;"><div class="full flex flex-col flex-centered" id="menu-col"><h1 id="osh" class="mb-2 mt-2">Oscillators</h1><p class="mb-2">Use oscillators to play instruments</p><div class="mb-5" class="flex flex-centered"><div id="os" class="flex"></div></div><h1 id="inh" class="mb-2">Instruments</h1><p class="mb-2" style="width: 75%">Use instruments to create sounds and collect additional notes</p><div class="full" class="flex flex-centered"><div id="dr" class="flex flex-row flex-centered"><p class="row-label">Drums</p></div><div id="bs" class="flex flex-row flex-centered"><p class="row-label">Basic Synths</p></div><div id="cs" class="flex flex-row flex-centered"><p class="row-label">Complex Synths</p></div></div></div></div><div class="flex centered flex-centered" id="inspect" style="visibility: hidden;"><div id="inner-inspect" class="full flex flex-centered flex-col"><button id="close-inspect">✖</button><h1 class="mb-2" id="inspect-name">SnareSound</h1><div class="flex flex-centered"><p>Cost:&nbsp;</p><p class="pink" id="inspect-cost">50</p></div><div class="flex flex-centered mb-2"><p>Notes produced:&nbsp;</p><p class="green" id="inspect-notes">50</p></div><button class="flex flex-centered mb-2" id="sell-button"><p>Sell for&nbsp;</p><p class="green" id="inspect-sell">50</p></button></div></div><button class="mb-5" id="menu-button">✖</button></div><div id="templates" class="hidden"><div class="flex flex-col flex-centered m-1"><p></p><button class="entity-button"><canvas class="full"></canvas></button><div class="flex"><span class="item-stats pink"><!-- cost # --> </span><span class="item-stats"><!-- / --> </span><span class="item-stats green"><!-- notes # --></span></div></div></div><script>(()=>{"use strict";var t={28:(t,s,n)=>{n.d(s,{t:()=>o});var e=n(645),i=n.n(e)()((function(t){return t[1]}));i.push([t.id,"* {\n  color: white;\n  text-align: center;\n  padding: 0;\n  margin: 0;\n  font-size: 2vh;\n  font-family: Tahoma, sans-serif;\n  user-select: none;\n  overscroll-behavior: none;\n}\n\nbody {\n  background-color: black;\n}\n\nh1 {\n  font-size: 3vh;\n  font-weight: normal;\n}\n\n\nbutton {\n  line-height: 0;\n  border-radius: 50%;\n  cursor: pointer;\n  border: .25vh solid white;\n  width: 7.5vh;\n  height: 7.5vh;\n  background-color: #272838;\n}\n\n:focus {\n  outline: none;\n}\n\n:disabled {\n  filter: brightness(.5) grayscale(.75)\n}\n\n.fill-absolute {\n  position: absolute;\n  top: 0;\n  left: 0;\n  overscroll-behavior: none;\n}\n\n.flex {\n  display: flex\n}\n\n.flex-col {\n  flex-direction: column;\n}\n\n.flex-centered {\n  align-items: center;\n  justify-content: center;\n}\n\n.centered {\n  position: absolute;\n  margin-left: auto;\n  margin-right: auto;\n}\n\n.full {\n  width: 100%;\n  height: 100%;\n}\n\n.full-w {\n  width: 100%;\n}\n\n.full-h {\n  height: 100%;\n}\n\n.pink {\n  color: #ff4c7a;\n}\n\n.green {\n  color: #00e19e;\n}\n\n.row-label {\n  width: 8vh;\n  /* flex-basis: 3vh; */\n}\n\n.hidden {\n  display: none;\n}\n\n.m-1 {\n  margin: 1vh;\n}\n\n.mb-5 {\n  margin-bottom: 5vh;\n}\n\n.mt-2 {\n  margin-top: 2vh;\n}\n\n.mb-2 {\n  margin-bottom: 2vh;\n}\n\n.item-stats {\n  line-height: 2.5vh;\n}\n\n#canvas-tiles {\n  filter: drop-shadow(0 0 3vh rgba(255,255,255,.5));\n  overflow: hidden;\n}\n\n#canvas-pre {\n  background-color: #272838;\n}\n\n#osh {\n  color: #ff4c7a;\n}\n\n#inh {\n  color: #00e19e;\n}\n\n#menu-button {\n  position: absolute;\n  align-self: flex-end;\n  background: rgba(255, 255, 255, 0.1);\n  transition-duration: 250ms;\n  transform: rotate(45deg);\n}\n\n#canvas-stats {\n  cursor: grab;\n}\n\n#menu, #inner-inspect {\n  background: rgba(0,0,0,.85);\n}\n\n#menu {\n  justify-content: flex-start;\n}\n\n#close-inspect {\n  position: absolute;\n  top: 1vh;\n  left: 1vh;\n  width: 5vh;\n  height: 5vh;\n}\n\n#inner-inspect {\n  position: relative;\n  width: 100%;\n  height: 50%;\n  box-sizing: border-box;\n}\n\n#sell-button {\n  border-radius: 3vh;\n  border: .25vh solid white;\n  padding: 2vh;\n  width: unset;\n  height: unset;\n}",""]);const o=i},645:t=>{t.exports=function(t){var s=[];return s.toString=function(){return this.map((function(s){var n=t(s);return s[2]?"@media ".concat(s[2]," {").concat(n,"}"):n})).join("")},s.i=function(t,n,e){"string"==typeof t&&(t=[[null,t,""]]);var i={};if(e)for(var o=0;o<this.length;o++){var r=this[o][0];null!=r&&(i[r]=!0)}for(var h=0;h<t.length;h++){var c=[].concat(t[h]);e&&i[c[0]]||(n&&(c[2]?c[2]="".concat(n," and ").concat(c[2]):c[2]=n),s.push(c))}},s}},379:t=>{var s=[];function n(t){for(var n=-1,e=0;e<s.length;e++)if(s[e].identifier===t){n=e;break}return n}function e(t,e){for(var o={},r=[],h=0;h<t.length;h++){var c=t[h],a=e.o?c[0]+e.o:c[0],u=o[a]||0,l="".concat(a," ").concat(u);o[a]=u+1;var d=n(l),p={h:c[1],media:c[2],u:c[3]};-1!==d?(s[d].l++,s[d].p(p)):s.push({identifier:l,p:i(p,e),l:1}),r.push(l)}return r}function i(t,s){var n=s.m(s);return n.update(t),function(s){if(s){if(s.h===t.h&&s.media===t.media&&s.u===t.u)return;n.update(t=s)}else n.remove()}}t.exports=function(t,i){var o=e(t=t||[],i=i||{});return function(t){t=t||[];for(var r=0;r<o.length;r++){var h=n(o[r]);s[h].l--}for(var c=e(t,i),a=0;a<o.length;a++){var u=n(o[a]);0===s[u].l&&(s[u].p(),s.splice(u,1))}o=c}}},569:t=>{var s={};t.exports=function(t,n){var e=function(t){if(void 0===s[t]){var n=document.querySelector(t);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(t){n=null}s[t]=n}return s[t]}(t);if(!e)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");e.appendChild(n)}},216:t=>{t.exports=function(t){var s=document.createElement("style");return t.v(s,t.attributes),t.g(s),s}},565:(t,s,n)=>{t.exports=function(t){var s=n.M;s&&t.setAttribute("nonce",s)}},795:t=>{t.exports=function(t){var s=t.k(t);return{update:function(n){!function(t,s,n){var e=n.h,i=n.media,o=n.u;i?t.setAttribute("media",i):t.removeAttribute("media"),o&&"undefined"!=typeof btoa&&(e+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(o))))," */")),s.q(e,t)}(s,t,n)},remove:function(){!function(t){if(null===t.parentNode)return!1;t.parentNode.removeChild(t)}(s)}}}},589:t=>{t.exports=function(t,s){if(s.styleSheet)s.styleSheet.cssText=t;else{for(;s.firstChild;)s.removeChild(s.firstChild);s.appendChild(document.createTextNode(t))}}}},s={};function n(e){var i=s[e];if(void 0!==i)return i.exports;var o=s[e]={id:e,exports:{}};return t[e](o,o.exports,n),o.exports}n.n=t=>{var s=t&&t.O?()=>t.default:()=>t;return n.d(s,{a:s}),s},n.d=(t,s)=>{for(var e in s)n.T(s,e)&&!n.T(t,e)&&Object.defineProperty(t,e,{A:!0,get:s[e]})},n.T=(t,s)=>Object.prototype.hasOwnProperty.call(t,s),(()=>{var t=n(379),s=n.n(t),e=n(795),i=n.n(e),o=n(569),r=n.n(o),h=n(565),c=n.n(h),a=n(216),u=n.n(a),l=n(589),d=n.n(l),p=n(28),m={};m.q=d(),m.v=c(),m.g=r().bind(null,"head"),m.m=i(),m.k=u();s()(p.t,m);p.t&&p.t.S&&p.t.S;const f="rgba(0,0,0,0)",v="#FFFFFF",w="#272838",y="rgba(189, 91, 255, .2)",x="#ff4c7a",b="#00e19e",g="rgba(0, 225, 158, .2)",M="#B0C4DE",k={root:document.getElementById("root"),F:document.getElementById("canvas-tiles"),$:document.getElementById("canvas-pre"),B:document.getElementById("canvas-post"),C:document.getElementById("canvas-stats"),L:document.getElementById("canvas-oscillators"),R:document.getElementById("canvas-instruments"),U:document.getElementById("menu"),j:document.getElementById("menu-button"),P:document.getElementById("menu-col"),X:document.getElementById("inspect"),Y:document.getElementById("inner-inspect"),N:document.getElementById("close-inspect"),I:document.getElementById("inspect-name"),D:document.getElementById("inspect-cost"),V:document.getElementById("inspect-notes"),H:document.getElementById("inspect-sell"),J:document.getElementById("sell-button")},q={K:k.F?.getContext("2d"),Z:k.$?.getContext("2d"),G:k.B?.getContext("2d"),W:k.C?.getContext("2d"),_:k.L?.getContext("2d"),tt:k.R?.getContext("2d")},E=2*Math.PI;class O{constructor({type:t,st:s=!1}={}){this.type=t,this.st=s}}class T{constructor(t=0,s=0){this.x=t,this.y=s}set(t,s){this.x=t,this.y=s}nt(){return this.x+this.y}}const A=new class{constructor(t){this.canvas=t}et(t){return this.canvas.width*((t+1)/2)}it(t){return this.canvas.height*((t+1)/2)}width(t=1,s=!1){return this.canvas.width*t/(s?window.devicePixelRatio:1)}height(t=1,s=!1){return this.canvas.height*t/(s?window.devicePixelRatio:1)}}(k.F),S=t=>t-63,F=t=>t-63,$=t=>t+63,B=t=>t+63,C=t=>A.width(.5)+(t-K.position.x)*A.width(.06)-A.width(.03),L=t=>A.height(.5)+(K.position.y-t)*A.width(.06)-A.width(.03),R=t=>{const{left:s,right:n}=k.F.getBoundingClientRect();if(!(t<s||t>n)){const n=A.width()/A.width(.06),e=(t-s)/A.width(1,!0),i=-n/2+e*n+K.position.x;return Math.round(i)}},U=t=>{const{top:s,bottom:n}=k.F.getBoundingClientRect();if(!(t<s||t>n)){const e=A.height()/A.width(.06),i=(n-t-s)/A.height(1,!0),o=-e/2+i*e+K.position.y;return Math.round(o)}},j=t=>C(S(t)),P=t=>L(F(t)),X=t=>void 0===t,Y=t=>{t.width=t.clientWidth*window.devicePixelRatio||1,t.height=t.clientHeight*window.devicePixelRatio||1},z=(t,s,n)=>t*n+s*(1-n),N=t=>{const s=t/1e6;if(s>1)return s.toFixed(1)+"M";const n=t/1e3;return n>1?n.toFixed(1)+"K":t+""},I="Tahoma, sans-serif",Q=(t,s,n=!1,e=!0,i=q.K)=>{e&&i.strokeRect(t,s,A.width(.06),A.width(.06)),n&&i.fillRect(t,s,A.width(.06),A.width(.06))},D=t=>{t.beginPath(),t.arc(A.et(0),A.it(0),A.width(.42),0,E),t.clip()},V=(t,s,n)=>{t.save(),t.strokeStyle=s,t.lineWidth=A.width(.2),t.beginPath(),n.forEach((([s,n],e)=>{const i=A.et(s),o=A.it(n);0===e?t.moveTo(i,o):t.lineTo(i,o)})),t.stroke(),t.restore()},H=(t,s,n,e,i)=>{t.save(),t.translate(s,n),t.rotate(i),t.translate(-s,-n),t.beginPath(),t.moveTo(s,n-e/2),t.quadraticCurveTo(s,n,s+e/2,n),t.quadraticCurveTo(s,n,s,n+e/2),t.quadraticCurveTo(s,n,s-e/2,n),t.quadraticCurveTo(s,n,s,n-e/2),t.restore()};const J={ot:0,rt:0},K=new class extends O{constructor({type:t="camera",coords:s}){super({type:t}),this.coords=s,this.position=new T,this.ht=new T,this.ct={at:void 0,ut:void 0,lt:void 0,dt:void 0},this.ft()}ft(){const t=Math.round(this.position.x),s=Math.round(this.position.y);this.ct={at:Math.max(0,$(t-7)),ut:Math.min(126,$(t+7)),lt:Math.max(0,B(s-7)),dt:Math.min(126,B(s+7))}}vt(){this.ft(),Y(k.F),q.K.fillStyle=w,q.K.strokeStyle=v,q.K.lineWidth=A.width(.006),D(q.K),q.K.fillRect(0,0,A.width(),A.height()),K.wt(((t,s,n)=>{Q(j(s),P(n))}))}wt(t){for(let s=this.ct.at;s<=this.ct.ut;s++)for(let n=this.ct.lt;n<=this.ct.dt;n++)t(Z[s][n],s,n)}yt(){(()=>{Y(k.C),q.W.font=`${A.width(.10500000000000001)}px ${I}`,q.W.fillStyle=v,q.W.textAlign="center";const t=q.W.measureText("SPACE JAM");q.W.font=`${A.width(.10500000000000001)}px ${I}`;const s="Current: "+N(J.ot);q.W.font=`${A.width(.07)}px ${I}`,q.W.fillText(s,A.et(0),A.it(-.85)+2*t.actualBoundingBoxAscent);const n=`(x: ${Math.round(K.position.x)}, y: ${Math.round(K.position.y)})`;q.W.font=`${A.width(.035)}px ${I}`,q.W.fillText(n,A.et(0),A.it(-.85)+3*t.actualBoundingBoxAscent)})(),this.wt(((t,s,n)=>{const{xt:e,state:i}=t;"instrument"===e?.type&&"playing"===i&&((t,s,n,e,i)=>{const o=s.width(.0165);t.fillStyle=w,t.globalAlpha=1,t.beginPath(),t.arc(n,e,o,0,E),t.fill(),t.globalAlpha=1,t.font=`${s.width(.0175)}px ${I}`,t.textAlign="center",t.fillStyle=v;const r="+"+i,h=t.measureText(r);t.fillText(r,n,e+h.actualBoundingBoxAscent/2)})(q.W,this.coords,C(S(s)+.5),L(F(n)-.5),e.bt)})),Y(k.L),q._.lineCap="round",q._.lineJoin="round",q._.lineWidth=A.width(.006),D(q._),K.wt((({xt:t})=>{"oscillator"===t?.type&&t.yt()})),Y(k.R),q.tt.font=`${A.width(.0175)}px ${I}`,q.tt.textAlign="center",q.tt.fillStyle=w,q.tt.strokeStyle=v,q.tt.lineWidth=A.width(.006),q.tt.lineJoin="round",D(q.tt),K.wt((({xt:t})=>{"instrument"===t?.type&&t.yt()})),this.gt?.yt()}}({coords:A}),Z=Array.from({length:127}).map((()=>Array.from({length:127},Object))),G=new Array(100).fill(null).map((()=>[1-2*Math.random(),1-2*Math.random(),.001*(1+Math.random()),Math.random()*E])),W=new Array(2).fill(null).map((()=>new Array(10).fill(null).map(((t,s)=>[.5-Math.random(),2.2*s/9-1.1])))),_=t=>new Float32Array(t),tt=()=>Math.random();class st{constructor(){this.context=new(window.AudioContext||window.webkitAudioContext)({sampleRate:44100}),this.Mt=new(window.OfflineAudioContext||window.webkitOfflineAudioContext)(2,88200,44100),this.kt=this.context.createDynamicsCompressor(),this.kt.threshold.value=-24,this.kt.knee.value=24,this.kt.ratio.value=12,this.kt.attack.value=0,this.kt.release.value=.25,this.qt=this.context.createGain(),this.qt.connect(this.context.destination),this.Et=this.context.createConvolver(),this.Et.connect(this.qt)}async init(){const t=await this.Ot();this.Et.buffer=t,this.Et.connect(this.qt)}async Ot(){return new Promise((t=>{const s=this.Mt.createGain();s.connect(this.Mt.destination),s.gain.setValueAtTime(1,0),s.gain.exponentialRampToValueAtTime(1e-4,2);const n=ct(this.Mt,"lowpass",5e3,s),e=ct(this.Mt,"highpass",500,n),i=this.Mt.createBufferSource();i.buffer=at(2),i.connect(e),i.start(),this.Mt.startRendering(),this.Mt.oncomplete=s=>{t(s.renderedBuffer)}}))}}st.Tt=196,st.At=2,st.St=44100;const nt=class{constructor(){this.Ft=[],this.$t=0}Bt(t,s){this.$t++;const n=this.$t,e=it.context.createBuffer(1,1,44100),i=it.context.createBufferSource();return i.buffer=e,i.connect(it.context.destination),this.Ft.push({id:n,time:t,type:"single",source:i}),i.onended=()=>{s(),this.cancel(n)},i.start(t-e.duration),n}Ct(t){t.count++;const s=it.context.createBufferSource();s.buffer=t.source.buffer,s.connect(it.context.destination),s.onended=()=>{t.Lt(),this.Ct(t)},s.start(t.time+t.count*t.frequency-s.buffer.duration),t.source=s}Rt(t,s,n){const e=it.context.createBuffer(1,1,44100),i=it.context.createBufferSource();i.buffer=e,i.connect(it.context.destination);const o={id:++this.$t,count:0,time:t,frequency:s,type:"repeating",Lt:n,source:i};return i.onended=()=>{n(),this.Ct(o)},i.start(Math.max(0,t-e.duration)),this.Ft.push(o),o.id}Ut(t){return this.Ft.find((s=>s.id===t))}clear(){this.Ft.forEach((t=>{t.source.onended=null,t.source.stop(),t.source.disconnect()})),this.Ft.length=0}cancel(t){const s=this.Ut(t);if(s){s.source.onended=null;try{s.source.stop()}catch(t){}s.source.disconnect(),this.Ft=this.Ft.filter((t=>t.id!==s.id))}}},et=[0,4,5,7,10],it=new st,ot=new nt,rt=(t,s,n=it.context.currentTime)=>{s&&s.forEach((({value:s,time:e,exp:i=!1})=>{i?t.exponentialRampToValueAtTime(s,n+e):t.linearRampToValueAtTime(s,n+e)}))},ht=t=>{let s;return s=t>0?2:.5,196*Math.pow(Math.pow(s,1/12),Math.abs(t))},ct=(t=it.context,s,n,e)=>{const i=t.createBiquadFilter();return i.frequency.value=n,i.type=s,e&&i.connect(e),i},at=t=>{const s=44100*t,n=_(s),e=_(s);for(let t=0;t<s;t++)n[t]=1-2*tt(),e[t]=1-2*tt();const i=it.context.createBuffer(2,s,44100);return i.getChannelData(0).set(n),i.getChannelData(1).set(e),i},ut=t=>{t.jt.pan.pan.value=(t.position.x-K.position.x)/7,t.jt.pan.pan.value=(t.position.y-K.position.y)/7},lt=(t,s=22050)=>{const n=100*t,e=new Float32Array(s),i=Math.PI/180;for(let t=0;t<s;t++){let o=2*t/s-1;e[t]=(3+n)*o*20*i/(Math.PI+n*Math.abs(o))}return e};class dt extends O{constructor(t={}){super(t);const{x:s,y:n,Pt:e=!1,id:i=""}=t;this.id=i,this.Pt=e,this.position=new T(s,n),this.Xt=0,this.Yt=M}}class pt extends dt{constructor(t){super(t),this.type="instrument",this.color=b}init(){this.zt=(t=>{let s=0,n=0,e=0,i=0;return t.forEach((t=>{const[o,r]=t;o<s&&(s=o),o>e&&(e=o),r<n&&(n=r),r>i&&(i=r)})),{Nt:s,It:e,Qt:n,Dt:i}})(this.outline),this.shape=((t,s,n)=>{const{Nt:e,It:i,Qt:o,Dt:r}=n,h=[],c=new Path2D;((t,s)=>{for(let n=0;n<s.length;n++){const[e,i]=s[n];0===n?t.moveTo(e,i):t.lineTo(e,i)}})(c,s);for(let s=e;s<i;s++)for(let n=o;n<r;n++)t.isPointInPath(c,s+.5,n+.5)&&h.push([s,n+1]);return h})(q.tt,this.outline,this.zt),this.Vt=this.zt.It-this.zt.Nt,this.Ht=this.zt.Dt-this.zt.Qt,this.Pt||this.Jt(),this.Kt=Math.round(this.Zt/3),ut(this)}Gt(){const{at:t,ut:s,lt:n,dt:e}=K.ct,{x:i,y:o}=this.position,r=$(i),h=B(o),c=Z[r][h],a=r>t&&r<s&&h>n&&h<e,u=Boolean(c.xt),l=c.Wt||!1,d=this.shape.some((([t,s])=>Z[r+t][h+s].Wt||Boolean(Z[r+t][h+s].xt)));return a&&!u&&!l&&!d}Jt(){this.Pt=!1;const t=$(this.position.x),s=B(this.position.y);Z[t][s].xt=this,this.shape.forEach((([n,e])=>{Z[t+n][s+e].Wt=!0}))}_t(){const t=$(this.position.x),s=B(this.position.y);Z[t][s]=new Object,this.shape.forEach((([n,e])=>{Z[t+n][s+e].Wt=!1}));for(let n=t-1;n<=t+1;n++)for(let t=s-1;t<=s+1;t++){const s=Z[n][t];if("oscillator"===s?.xt?.type){s.xt.ts()}}}yt(t=q.tt,s=!0){t.save(),t.fillStyle=this.disabled?M:this.color,t.beginPath();for(let s=0;s<this.outline.length;s++){const[n,e]=this.outline[s],i=C(this.position.x+n),o=L(this.position.y+e);0===s?t.moveTo(i,o):t.lineTo(i,o)}t.closePath(),t.clip();const{Nt:n,Dt:e}=this.zt;if(t.fillRect(C(this.position.x+n),L(this.position.y+e),A.width(.06)*this.Vt,A.width(.06)*this.Ht),t.stroke(),s){const s=C(this.position.x+.5),n=L(this.position.y-.5);t.fillStyle=v,t.beginPath(),t.arc(s,n,A.width(.015),0,E),t.fill(),t.fillStyle=w;const e=this.display.substr(0,1),i=t.measureText(e);t.fillText(this.display.substr(0,1),s,n+i.actualBoundingBoxAscent/2)}t.restore()}}class mt{constructor(t={}){this.note=t.note,this.ss=0,this.pan=it.context.createStereoPanner(),this.ns={baseVolume:.5,baseReverb:0,lpEnvQ:1.7,hpEnvQ:1.7}}play(t,s=this.es()){}os(){if(!this.rs)return!1;let t=!1;for(let s in Object.values(this.rs)){s.length>0&&(t=!0);break}return t}hs(){const t=[...(this.rs?.filters||[]).map((({cs:t,type:s,frequency:n,gain:e})=>{const i=it.context.createBiquadFilter();return i.type=s,t&&(i.Q.value=t),n&&(i.frequency.value=n),e&&(i.gain.value=e),i})),...(this.rs?.us||[]).map((({threshold:t,attack:s,knee:n,ratio:e,release:i})=>{const o=it.context.createDynamicsCompressor();return o.threshold.value=t,o.attack.value=s,o.knee.value=n,o.ratio.value=e,o.release.value=i,o})),...(this.rs?.ls||[]).map((({curve:t})=>{const s=it.context.createWaveShaper();return s.curve=t,s}))];return console.log(t),t.forEach(((t,s,n)=>{s!==n.length-1&&t.connect(n[s+1])})),t}ds(t,s,n={}){const e=it.context.createGain();rt(e.gain,this.ps.amplitude);const i=it.context.createGain();i.gain.value=1-this.ns.baseReverb;const o=it.context.createGain();o.gain.value=this.ns.baseReverb;const r=it.context.createBiquadFilter();r.type="lowpass",r.frequency.value=2e4,r.Q.value=this.fs("lpEnvQ",n.lpEnvQ);const h=it.context.createBiquadFilter();h.type="highpass",h.frequency.value=20,h.Q.value=this.fs("hpEnvQ",n.hpEnvQ);const c=it.context.createGain();c.gain.value=this.ns.baseVolume,this.ps?.vs&&rt(r.frequency,this.ps.vs),this.ps?.ws&&rt(h.frequency,this.ps.ws);const{source:a,gain:u}=s;if(a.connect(u),u.connect(e),e.connect(r),r.connect(h),this.os()){const t=this.hs(),s=t[0],n=t.pop();h.connect(s),n.connect(c)}else r.connect(c);c.connect(i),c.connect(o),i.connect(it.qt),o.connect(it.Et),a.start(t),a.stop(t+this.duration),a.onended=()=>{a.disconnect()}}ys(t,s,n={}){let e;const i=it.context.createGain(),o=this.es(s);if("waveform"===t){const{xs:t}=n;e=it.context.createOscillator(),e.type=t,e.frequency.value=ht(o)}if("harmonics"===t){const{bs:t,xs:s}=n;if(e=it.context.createOscillator(),e.type=s,!t)throw new Error("harmonic option required");i.gain.value=.2/(1+Math.log2(t)),e.frequency.value=ht(o)*t}if("waveform"!==t&&"harmonics"!==t||(this.duration=this.ps.amplitude?.map((({time:t})=>t)).reduce(((t,s)=>t+s))||0),"sample"===t){const{buffer:t}=n;e=it.context.createBufferSource(),e.buffer=t,this.duration=t.duration}return{source:e,gain:i,note:s}}fs(t,s){return X(s)?this.ns[t]:s}es(t){return X(t)?X(this.note)?this.ss+et[Math.floor(Math.random()*et.length)]:this.ss+this.note:this.ss+t}}class ft extends mt{constructor(t={}){super(t),this.ss=-24,this.ps={amplitude:[{time:0,value:1},{time:.75,value:1e-4,exp:!0}]},this.rs={ls:[{curve:lt(.2)}]},this.ns.baseVolume=.5}play(t,s){const n=this.ys("waveform",s,{xs:"sine"});this.ds(t,n)}}class vt extends pt{constructor(t={}){super(t),this.gs="dr",this.display="Kick",this.Zt=50,this.bt=3,this.outline=[[0,0],[1,0],[1,-1],[0,-1]],this.jt=new ft({note:0}),this.init()}}class wt extends mt{constructor(t={}){super(t),this.ss=0,this.ps={amplitude:[{time:0,value:0},{time:.015,value:1},{time:.45,value:1e-4,exp:!0}]},this.rs={filters:[{type:"highpass",frequency:90,cs:1.7}]},this.ns.baseReverb=.05,this.ns.baseVolume=.25}play(t,s=this.es()){const n=this.ys("waveform",s,{xs:"sine"});n.gain.gain.value=.3;const e=this.ys("sample",s,{buffer:it.Et.buffer});e.gain.gain.value=.5,this.ds(t,n),this.ds(t,e)}}class yt extends pt{constructor(t={}){super(t),this.gs="dr",this.display="Snare",this.Zt=25,this.bt=2,this.outline=[[0,0],[1,0],[1,-1],[0,-1]],this.jt=new wt({note:0}),this.init()}}class xt extends dt{constructor(t={}){super(t),this.type="oscillator",this.Ms=[]}init(){this.Pt||this.Jt(),this.Kt=Math.round(this.Zt/3)}ks(){return it.context.currentTime%this.duration/this.duration}Gt(){const{at:t,ut:s,lt:n,dt:e}=K.ct,{x:i,y:o}=this.position,r=$(i),h=B(o),c=Z[r][h],a=r>t&&r<s&&h>n&&h<e,u=Boolean(c.xt),l=c.Wt||!1;return a&&!u&&!l}Jt(){this.Pt=!1,Z[$(this.position.x)][B(this.position.y)].xt=this,this.Ms.forEach((t=>{ot.cancel(t)})),this.ts()}_t(){const t=$(this.position.x),s=B(this.position.y);Z[t][s]=new Object,this.qs()}yt(){const t=C(this.position.x+.5),s=L(this.position.y-.5);this.Es(t,s),this.Os(t,s),this.Pt&&(q._.globalAlpha=.5,this.Ts.forEach((t=>{const[s,n]=t;q._.beginPath(),Q(C(this.position.x+s),L(this.position.y+n),!0,!1,q._)})),q._.globalAlpha=1)}Os(t,s){q._.moveTo(t,s);const n=this.ks();let e,i;for(let t=0;t<this.Ts.length;t++){const s=(t+1)/this.Ts.length;if(n<s){const o=(s-n)*this.Ts.length;e=C(this.position.x+.5+z(this.Ts[t][0],this.Ts[(t+1)%this.Ts.length][0],o)),i=L(this.position.y-.5+z(this.Ts[t][1],this.Ts[(t+1)%this.Ts.length][1],o)),q._.lineTo(e,i),q._.stroke(),q._.beginPath(),q._.arc(e,i,A.width(.015),0,E),q._.fill();break}}}Es(t,s){}qs(){this.Ms.forEach((t=>{ot.cancel(t)}))}ts(){this.qs();const t=$(this.position.x),s=B(this.position.y),n=Math.ceil(Math.max(this.ks()||.1)*this.Ts.length),e=(t=>{const s=it.context.currentTime/t;return(Math.floor(s)+1)*t})(this.interval);for(let i=0;i<this.Ts.length;i++){const o=e+i*this.interval,r=(i+n)%this.Ts.length,h=this.Ts[r],c=Z[t+h[0]][s+h[1]];this.Ms.push(ot.Rt(o,this.duration,(()=>{if("instrument"===c?.xt?.type&&"playing"!==c.state){c.state="playing";const t=c.xt,s=t.bt;this.Xt+=s,J.ot+=s,J.rt+=s,t.Xt+=s,t.jt.play(it.context.currentTime),ot.Bt(it.context.currentTime+.7714285714285714,(()=>{c.state="stopped"}))}})))}}}class bt extends xt{constructor(t={}){super(t)}init(){this.Ts=[[0,this.As],[this.As,0],[0,-this.As],[-this.As,0]],this.duration=this.interval*this.Ts.length,super.init()}Es(t,s,n=q._,e=A.width(.024),i=A.width(.006),o=(this.disabled?this.Yt:this.color)){n.strokeStyle=o,n.fillStyle=o,n.lineWidth=i,n.beginPath(),n.arc(t,s,e,0,E)}Os(t,s){q._.moveTo(t,s);const n=((t,s,n,e,i)=>({x:Math.cos(i)*(t-n)-Math.sin(i)*(s-e)+n,y:Math.sin(i)*(t-n)+Math.cos(i)*(s-e)+e}))(t+A.width(.06*this.As),s,t,s,E*this.ks()-Math.PI/2);q._.lineTo(n.x,n.y),q._.stroke(),q._.beginPath(),q._.arc(n.x,n.y,A.width(.015),0,E),q._.fill()}}class gt extends bt{constructor(t={}){super(t),this.display="Circle",this.Zt=25,this.As=1,this.color=x,this.interval=.8571428571428571,this.init()}}const Mt={screenX:void 0,screenY:void 0,Ss:void 0,Fs:void 0},kt=new class{constructor(t,s){this.x=t,this.y=s}}(9,16);let qt=!1,Et=!1;const Ot=()=>{"hidden"===k.U.style.visibility?(k.U.style.visibility="visible",k.j.style.transform="rotate(0deg)",qt=!0,St(),Et&&Tt(),K.gt=null,document.addEventListener("mousedown",Bt)):(k.U.style.visibility="hidden",k.j.style.transform="rotate(45deg)",qt=!1,document.removeEventListener("mousedown",Bt))},Tt=()=>{"hidden"===k.X.style.visibility?(k.X.style.visibility="visible",Et=!0,At(),document.addEventListener("mousedown",Bt)):(k.X.style.visibility="hidden",Et=!1,K.$s=null,document.removeEventListener("mousedown",Bt))},At=()=>{if(K.$s){const t=Math.round(K.$s.Zt/3);k.D.innerHTML=N(K.$s.Zt),k.I.innerHTML=K.$s.display,k.V.innerHTML=N(K.$s.Xt),k.H.innerHTML=N(t)}},St=()=>{},Ft=()=>{K.$s&&(K.$s._t(),J.ot+=K.$s.Kt,J.rt+=K.$s.Kt,Tt())},$t=()=>{Y(k.$),q.Z.fillStyle="purple",q.Z.strokeStyle="white",G.forEach((([t,s,n,e])=>{q.Z.lineWidth=A.width(n),H(q.Z,A.et(t),A.it(s),A.width(6*n),e),q.Z.fill(),q.Z.stroke()})),V(q.Z,y,W[0]),V(q.Z,g,W[1]),(()=>{const t=q.G.createRadialGradient(A.et(0),A.it(0),A.width(.21),A.et(0),A.it(0),A.width(.42));t.addColorStop(0,f),t.addColorStop(.25,f),t.addColorStop(1,w),Y(k.B),q.G.lineWidth=A.width(.006),q.G.strokeStyle=v,q.G.fillStyle=t,q.G.beginPath(),q.G.arc(A.et(0),A.it(0),A.width(.42),0,E),q.G.fill(),q.G.stroke()})(),K.vt()},Bt=t=>{!qt||k.U.contains(t.target)||k.j.contains(t.target)||Ot(),Et&&!k.Y.contains(t.target)&&Tt()},Ct=t=>{"Escape"===t.key&&qt&&Ot()},Lt=t=>{"Escape"===t.key&&Et&&Tt()},Rt=t=>{Mt.screenX=t.x,Mt.screenY=t.y,Mt.Ss=R(t.x),Mt.Fs=U(t.y)},Ut=t=>{if(it.context.resume(),!qt&&!Et){const s=.06*k.F.clientWidth;let n=t.clientX,e=t.clientY;const{x:i,y:o}=K.position,r=t=>{const r=t.clientX-n,h=t.clientY-e;K.position.set(i-r/s,o+h/s),K.vt();for(let t=K.ct.at;t<=K.ct.ut;t++)for(let s=K.ct.lt;s<=K.ct.dt;s++){const n=Z[t][s]?.xt;"instrument"===n?.type&&ut(n)}},h=()=>{document.removeEventListener("mousemove",r),document.addEventListener("mousemove",Rt)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",h,{once:!0}),document.removeEventListener("mousemove",Rt)}};document.addEventListener("mousedown",(t=>{K.$s&&!Et&&Tt()}),{capture:!1}),document.addEventListener("mousemove",(()=>{if(qt||Et)return;if(X(Mt.Ss)||X(Mt.Fs))return;const t=$(Mt.Ss),s=B(Mt.Fs);if(X(t)||X(s))return;const n=Z[t][s];return K.$s=n.xt,n.xt?k.C.style.cursor="pointer":k.C.style.cursor="grab",n}),{capture:!1});const jt=()=>{[k.F,k.$,k.B,k.C,k.L,k.R,k.U,k.X].forEach((t=>{(t=>{const s=t.parentElement;new ResizeObserver((()=>{const{width:n,height:e}=s.getBoundingClientRect(),i=Math.min(n/kt.x,e/kt.y),o=i*kt.x,r=i*kt.y,h=window.devicePixelRatio||1;t.width=o*h,t.height=r*h,t.style.width=o+"px",t.style.height=r+"px",K.vt()})).observe(s)})(t)})),k.j.addEventListener("click",Ot),k.N.addEventListener("click",Tt),k.J.addEventListener("click",Ft),document.addEventListener("keydown",Ct),document.addEventListener("keydown",Lt),document.addEventListener("mousemove",Rt),document.addEventListener("mousedown",Ut);new ResizeObserver($t).observe(k.root)};class Pt extends mt{constructor(t={}){super(t),this.ss=0,this.ps={amplitude:[{time:0,value:0},{time:.01,value:1},{time:.25,value:1e-4,exp:!0}]},this.rs={filters:[{type:"highpass",frequency:350,cs:1.7},{type:"peaking",gain:-12,frequency:8780,cs:.85},{type:"lowpass",frequency:18e3,cs:.59}]},this.ns.baseVolume=.1}play(t,s){const n=this.ys("sample",s,{buffer:it.Et.buffer});n.source.detune.value=2400,this.ds(t,n)}}class Xt extends pt{constructor(t={}){super(t),this.gs="dr",this.display="HiHat",this.Zt=5,this.bt=1,this.outline=[[0,0],[1,0],[1,-1],[0,-1]],this.jt=new Pt({note:0}),this.init()}}class Yt extends mt{constructor(t){super(t)}play(t,s){this.Bs?.forEach((n=>{const e=this.ys("harmonics",s,{xs:"sine",bs:n});this.ds(t,e)})),this.Cs?.forEach((n=>{const e=this.ys("harmonics",s,{xs:"square",bs:n});this.ds(t,e)})),this.Ls?.forEach((n=>{const e=this.ys("harmonics",s,{xs:"sawtooth",bs:n});this.ds(t,e)}))}}class zt extends Yt{constructor(t={}){super(t),this.Bs=[1,2,4,8],this.ps={amplitude:[{time:0,value:0},{time:.05,value:1},{time:.35,value:0}],vs:[{time:.35,value:.001,exp:!0}]},this.ns.baseReverb=.2,this.rs={filters:[{type:"lowpass",frequency:2500,cs:.71}]}}}class Nt extends pt{constructor(t={}){super(t),this.gs="bs",this.display="Organ",this.Zt=25,this.bt=2,this.outline=[[0,1],[0,0],[0,-1],[1,-1],[2,-1],[2,0],[1,0],[1,1]],this.jt=new zt,this.init()}}class It extends Yt{constructor(t={}){super(t),this.Ls=[1],this.ps={amplitude:[{time:0,value:0},{time:.01,value:1},{time:.7,value:0}],vs:[{time:0,value:0,exp:!1},{time:.15,value:5e3,exp:!1}]},this.ns.baseReverb=.4,this.rs={filters:[{type:"lowpass",frequency:1500,cs:1}]}}}class Qt extends pt{constructor(t={}){super(t),this.gs="bs",this.display="Saw",this.Zt=50,this.bt=3,this.outline=[[0,0],[1,0],[1,-1],[1,-2],[0,-2],[0,-1],[-1,-1],[-1,0]],this.jt=new It,this.init()}}class Dt extends Yt{constructor(t={}){super(t),this.Bs=[1,8,9,12,15],this.ps={amplitude:[{time:0,value:0},{time:.01,value:1},{time:.35,value:0}],vs:[{time:.35,value:.001,exp:!0}]},this.ns.baseReverb=.2,this.rs={filters:[{type:"lowpass",frequency:2500,cs:.71}]}}}class Vt extends pt{constructor(t={}){super(t),this.gs="bs",this.display="Sine",this.Zt=75,this.bt=4,this.outline=[[0,0],[0,1],[1,1],[1,0],[1,-1],[0,-1],[-1,-1],[-1,0]],this.jt=new Dt,this.init()}}class Ht extends Yt{constructor(t={}){super(t),this.Bs=[2,4,6],this.Cs=[1],this.ps={amplitude:[{time:0,value:0},{time:.01,value:1},{time:.15,value:0}],vs:[{time:.35,value:.001,exp:!0}]},this.ns.baseReverb=.2,this.rs={filters:[{type:"lowpass",frequency:1500,cs:.71}]}}}class Jt extends pt{constructor(t={}){super(t),this.gs="bs",this.display="Square",this.Zt=100,this.bt=5,this.outline=[[0,0],[1,0],[2,0],[2,-1],[1,-1],[1,-2],[0,-2],[0,-1]],this.jt=new Ht,this.init()}}class Kt extends mt{constructor(t={}){super(t),this.ss=0,this.ps={amplitude:[{time:0,value:1},{time:.25,value:1e-4,exp:!0}]},this.ns.baseReverb=.05}play(t,s){const n=this.ys("waveform",s,{xs:"sine"});n.gain.gain.value=.5,this.ds(t,n)}}class Zt extends pt{constructor(t={}){super(t),this.gs="dr",this.display="Tom",this.Zt=15,this.bt=3,this.outline=[[0,0],[1,0],[1,-1],[0,-1]],this.jt=new Kt,this.init()}}const Gt=[t=>new Xt(t),t=>new Zt(t),t=>new yt(t),t=>new vt(t),t=>new Nt(t),t=>new Qt(t),t=>new Vt(t),t=>new Jt(t)];class Wt extends xt{constructor(t={}){super(t),this.width=1}Es(t,s,n=q._,e=A.width(.06*this.width-.012),i=A.width(.006),o=(this.disabled?this.Yt:this.color)){n.strokeStyle=o,n.fillStyle=o,n.lineWidth=i,n.beginPath(),n.strokeRect(t-e/2,s-e/2,e,e),n.stroke()}}class _t extends Wt{constructor(t={}){super(t),this.display="Square",this.interval=.21428571428571427,this.Zt=500,this.color=x,this.Ts=[[0,1],[1,1],[1,0],[1,-1],[0,-1],[-1,-1],[-1,0],[-1,1]],this.duration=this.interval*this.Ts.length,this.init()}}class ts extends xt{constructor(t={}){super(t),this.width=1}Es(t,s,n=q._,e=A.width(.06*this.width-.012),i=A.width(.006),o=(this.disabled?this.Yt:this.color)){n.strokeStyle=o,n.fillStyle=o,n.lineWidth=i,n.beginPath(),((t,s,n,e)=>{const i=e*Math.sqrt(3)/2;t.beginPath(),t.moveTo(s,n-i/2),t.lineTo(s+e/2,n+i/2),t.lineTo(s-e/2,n+i/2),t.closePath()})(n,t,s,e),n.stroke()}}class ss extends ts{constructor(t={}){super(t),this.display="Triangle",this.interval=.5714285714285714,this.Zt=50,this.color=x,this.Ts=[[0,1],[1,-1],[-1,-1]],this.duration=this.interval*this.Ts.length,this.init()}}const ns=[t=>new gt(t),t=>new ss(t),t=>new _t(t)],es=(t,s)=>{const{type:n,Zt:e}=t,i=document.getElementById("templates").firstElementChild.cloneNode(!0),o=i.querySelector("button");o.classList.add("entity-button"),o.setAttribute("cost",e.toString());const r=i.querySelector("canvas");i.querySelector("p").innerHTML=t.display;const h=i.querySelectorAll("span");h[0].innerHTML="-"+t.Zt,"instrument"===n&&(h[1].innerHTML="&nbsp;/&nbsp;",h[2].innerHTML="+"+t.bt);const c="instrument"===n?t.gs:"os";document.getElementById(c).append(i),o.onclick=n=>{n.stopPropagation(),Ot(),((t,s)=>{t.position.set(Mt.Ss,Mt.Fs),K.gt=t,k.C.style.cursor="pointer";const n=()=>{const s=Mt.Ss,n=Mt.Fs;void 0!==s&&void 0!==n&&(t.position.set(s,n),t.disabled=!t.Gt())},e=()=>{if(t.disabled)document.addEventListener("click",e,{once:!0});else{const{x:e,y:i}=t.position;s({x:e,y:i}),J.ot-=K.gt.Zt,K.gt=null,document.removeEventListener("mousemove",n),k.C.style.cursor="grab"}};document.addEventListener("keydown",(t=>{"Escape"===t.key&&(K.gt=null,document.removeEventListener("mousemove",n),document.removeEventListener("click",e),k.C.style.cursor="grab")})),document.addEventListener("mousemove",n),document.addEventListener("click",e,{once:!0})})(t,s)};new ResizeObserver((()=>{Y(r),((t,s)=>{Y(t);const n=t.getContext("2d"),e=s.id.substr(0,2);if("oscillator"===s.type&&(s.Es(t.width/2,t.height/2,n,t.width*("co"===e?.15:.3),t.width/15),n.stroke()),"instrument"===s.type){const e=s;t.width=k.R.width,t.height=k.R.height;const i=5/Math.max(e.Vt,e.Ht),{x:o,y:r}=kt;n.save(),n.setTransform(i,0,0,i*r/o,-(i-1)*t.width/2,-(i*r/o-1)*t.height/2),s.yt(n,!1),n.restore(),n.scale(1,r/o)}})(r,t)})).observe(o)},is=async()=>{await it.init(),jt(),[...ns,...Gt].forEach((t=>{const s=t({Pt:!0});es(s,t)})),St(),K.vt(),new vt({x:1,y:0}),new yt({x:-1,y:0}),new gt({x:0,y:0});let t=0;const s=n=>{K.yt(),(qt||Et)&&J.ot!==t&&(St(),At()),t=J.ot,window.requestAnimationFrame(s)};window.requestAnimationFrame(s)};window.addEventListener("DOMContentLoaded",(()=>{is()}))})()})();</script></body></html>