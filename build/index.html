<html><head><link href="main.css" rel="stylesheet"></head><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1.01"><title>JS13k 2021</title><link rel="stylesheet" href="./styles.css"><body class="full"><div id="root" class="full flex flex-centered fill-absolute"><canvas class="centered" id="canvas-pre"></canvas><canvas class="centered hide-intro" id="canvas-tiles"></canvas><canvas class="centered hide-intro" id="canvas-instruments"></canvas><canvas class="centered hide-intro" id="canvas-oscillators"></canvas><canvas class="centered hide-intro" id="canvas-post"></canvas><canvas class="centered hide-intro" id="canvas-stats"></canvas><div class="full centered flex flex-centered" id="menu" style="visibility: hidden;"><div class="full flex flex-col flex-centered" id="menu-col"><h1 id="osh" class="mb-2 mt-2">Oscillators</h1><p class="mb-2">Use oscillators to play instruments</p><div class="mb-5" class="flex flex-centered"><div id="os" class="flex"></div></div><h1 id="inh" class="mb-2">Instruments</h1><p class="mb-2" style="width: 75%">Use instruments to emit sounds and collect additional notes</p><div class="full" class="flex flex-centered"><div id="dr" class="flex flex-row flex-centered"><p class="row-label">Drums</p></div><div id="bs" class="flex flex-row flex-centered"><p class="row-label">Basic Synths</p></div><div id="cs" class="flex flex-row flex-centered"><p class="row-label">Complex Synths</p></div></div></div></div><div class="flex centered flex-centered" id="inspect" style="visibility: hidden;"><div id="inner-inspect" class="full flex flex-centered flex-col"><button id="close-inspect">✖</button><h1 class="mb-2" id="inspect-name">SnareSound</h1><div class="flex flex-centered"><p>Cost:&nbsp;</p><p class="pink" id="inspect-cost">50</p></div><div class="flex flex-centered mb-2"><p>Notes produced:&nbsp;</p><p class="green" id="inspect-notes">50</p></div><button class="flex flex-centered mb-2" id="sell-button"><p>Sell for&nbsp;</p><p class="green" id="inspect-sell">50</p></button></div></div><button class="mb-5 hide-intro" id="menu-button">✖</button><div id="intro" class="full flex flex-col flex-centered fill-absolute"><h1 id="title">SPACE JAM</h1><br><h2>You are the first to reach the planet Mixolydia,</h2><h2>where the only resource is sound.</h2><br><h2>What will you make of this new frontier?</h2><br><div class="flex"><button disabled="disabled" id="start">Start</button></div></div></div><div id="templates" class="hidden"><div class="flex flex-col flex-centered m-1"><p></p><button class="entity-button"><canvas class="full"></canvas></button><div class="flex"><span class="item-stats pink"><!-- cost # --> </span><span class="item-stats"><!-- / --> </span><span class="item-stats green"><!-- notes # --></span></div></div></div><script>(()=>{"use strict";var t={d:(s,e)=>{for(var i in e)t.t(e,i)&&!t.t(s,i)&&Object.defineProperty(s,i,{i:!0,get:e[i]})},t:(t,s)=>Object.prototype.hasOwnProperty.call(t,s)};t.d({},{a:()=>es});const s="rgba(0,0,0,0)",e="#FFFFFF",i="#272838",n="rgba(189, 91, 255, .2)",h="#ff4c7a",o="#00e19e",r="rgba(0, 225, 158, .2)",c="#B0C4DE",a={root:document.getElementById("root"),h:document.getElementById("canvas-tiles"),o:document.getElementById("canvas-pre"),u:document.getElementById("canvas-post"),l:document.getElementById("canvas-stats"),p:document.getElementById("canvas-oscillators"),m:document.getElementById("canvas-instruments"),v:document.getElementById("menu"),M:document.getElementById("menu-button"),g:document.getElementById("menu-col"),q:document.getElementById("inspect"),T:document.getElementById("inner-inspect"),k:document.getElementById("close-inspect"),A:document.getElementById("inspect-name"),O:document.getElementById("inspect-cost"),F:document.getElementById("inspect-notes"),S:document.getElementById("inspect-sell"),$:document.getElementById("sell-button"),B:document.getElementById("intro"),start:document.getElementById("start")},u={R:a.h?.getContext("2d"),C:a.o?.getContext("2d"),P:a.u?.getContext("2d"),L:a.l?.getContext("2d"),U:a.p?.getContext("2d"),X:a.m?.getContext("2d")},l=2*Math.PI;class p{constructor({type:t,Y:s=!1}={}){this.type=t,this.Y=s}}class m{constructor(t=0,s=0){this.x=t,this.y=s}set(t,s){this.x=t,this.y=s}j(){return this.x+this.y}}const d=new class{constructor(t){this.canvas=t}N(t){return this.canvas.width*((t+1)/2)}I(t){return this.canvas.height*((t+1)/2)}width(t=1,s=!1){return this.canvas.width*t/(s?window.devicePixelRatio:1)}height(t=1,s=!1){return this.canvas.height*t/(s?window.devicePixelRatio:1)}}(a.h),w=t=>t-63,y=t=>t-63,v=t=>t+63,f=t=>t+63,x=t=>d.width(.5)+(t-L.position.x)*d.width(.06)-d.width(.03),M=t=>d.height(.5)+(L.position.y-t)*d.width(.06)-d.width(.03),g=t=>{const{left:s,right:e}=a.h.getBoundingClientRect();if(!(t<s||t>e)){const e=d.width()/d.width(.06),i=(t-s)/d.width(1,!0),n=-e/2+i*e+L.position.x;return Math.round(n)}},q=t=>{const{top:s,bottom:e}=a.h.getBoundingClientRect();if(!(t<s||t>e)){const i=d.height()/d.width(.06),n=(e-t-s)/d.height(1,!0),h=-i/2+n*i+L.position.y;return Math.round(h)}},b=t=>x(w(t)),T=t=>M(y(t)),E=t=>void 0===t,k=t=>{t.width=t.clientWidth*window.devicePixelRatio||1,t.height=t.clientHeight*window.devicePixelRatio||1},A=(t,s,e)=>Math.max(s,Math.min(t,e)),O=(t,s,e)=>t*e+s*(1-e),F=t=>{const s=t/1e6;if(s>1)return s.toFixed(1)+"M";const e=t/1e3;return e>1?e.toFixed(1)+"K":t+""},S="Tahoma, sans-serif",$=(t,s,e=!1,i=!0,n=u.R)=>{i&&n.strokeRect(t,s,d.width(.06),d.width(.06)),e&&n.fillRect(t,s,d.width(.06),d.width(.06))},B=t=>{t.beginPath(),t.arc(d.N(0),d.I(0),d.width(.42),0,l),t.clip()},R=(t,s,e)=>{t.save(),t.strokeStyle=s,t.lineWidth=d.width(.2),t.beginPath(),e.forEach((([s,e],i)=>{const n=d.N(s),h=d.I(e);0===i?t.moveTo(n,h):t.lineTo(n,h)})),t.stroke(),t.restore()},C=(t,s,e,i,n)=>{t.save(),t.translate(s,e),t.rotate(n),t.translate(-s,-e),t.beginPath(),t.moveTo(s,e-i/2),t.quadraticCurveTo(s,e,s+i/2,e),t.quadraticCurveTo(s,e,s,e+i/2),t.quadraticCurveTo(s,e,s-i/2,e),t.quadraticCurveTo(s,e,s,e-i/2),t.restore()};const P={V:0,H:0},L=new class extends p{constructor({type:t="camera",coords:s}){super({type:t}),this.coords=s,this.position=new m,this.D=new m,this.K={J:void 0,G:void 0,W:void 0,Z:void 0},this._()}_(){const t=Math.round(this.position.x),s=Math.round(this.position.y);this.K={J:Math.max(0,v(t-7)),G:Math.min(126,v(t+7)),W:Math.max(0,f(s-7)),Z:Math.min(126,f(s+7))}}tt(){this._(),k(a.h),u.R.fillStyle=i,u.R.strokeStyle=e,u.R.lineWidth=d.width(.006),B(u.R),u.R.fillRect(0,0,d.width(),d.height()),L.st(((t,s,e)=>{$(b(s),T(e))}))}st(t){for(let s=this.K.J;s<=this.K.G;s++)for(let e=this.K.W;e<=this.K.Z;e++)t(U[s][e],s,e)}et(){(()=>{k(a.l),u.L.font=`${d.width(.10500000000000001)}px ${S}`,u.L.fillStyle=e,u.L.textAlign="center";const t=u.L.measureText("SPACE JAM");u.L.font=`${d.width(.10500000000000001)}px ${S}`;const s="Current: "+F(P.V);u.L.font=`${d.width(.07)}px ${S}`,u.L.fillText(s,d.N(0),d.I(-.85)+2*t.actualBoundingBoxAscent);const i=`(x: ${Math.round(L.position.x)}, y: ${Math.round(L.position.y)})`;u.L.font=`${d.width(.035)}px ${S}`,u.L.fillText(i,d.N(0),d.I(-.85)+3*t.actualBoundingBoxAscent)})(),this.st(((t,s,n)=>{const{it:h,state:o}=t;"instrument"===h?.type&&"playing"===o&&((t,s,n,h,o)=>{const r=s.width(.0165);t.fillStyle=i,t.globalAlpha=1,t.beginPath(),t.arc(n,h,r,0,l),t.fill(),t.globalAlpha=1,t.font=`${s.width(.0175)}px ${S}`,t.textAlign="center",t.fillStyle=e;const c="+"+o,a=t.measureText(c);t.fillText(c,n,h+a.actualBoundingBoxAscent/2)})(u.L,this.coords,x(w(s)+.5),M(y(n)-.5),h.nt)})),k(a.p),u.U.lineCap="round",u.U.lineJoin="round",u.U.lineWidth=d.width(.006),B(u.U),L.st((({it:t})=>{"oscillator"===t?.type&&t.et()})),k(a.m),u.X.font=`${d.width(.0175)}px ${S}`,u.X.textAlign="center",u.X.fillStyle=i,u.X.strokeStyle=e,u.X.lineWidth=d.width(.006),u.X.lineJoin="round",B(u.X),L.st((({it:t})=>{"instrument"===t?.type&&t.et()})),this.ht?.et()}}({coords:d}),U=Array.from({length:127}).map((()=>Array.from({length:127},Object))),X=new Array(100).fill(null).map((()=>[1-2*Math.random(),1-2*Math.random(),.001*(1+Math.random()),Math.random()*l])),Y=new Array(2).fill(null).map((()=>new Array(10).fill(null).map(((t,s)=>[.5-Math.random(),2.2*s/9-1.1])))),j=t=>new Float32Array(t),N=()=>Math.random();class I{constructor(){this.context=new(window.AudioContext||window.webkitAudioContext)({sampleRate:44100}),this.ot=new(window.OfflineAudioContext||window.webkitOfflineAudioContext)(2,88200,44100),this.rt=this.context.createDynamicsCompressor(),this.rt.threshold.value=-24,this.rt.knee.value=24,this.rt.ratio.value=12,this.rt.attack.value=0,this.rt.release.value=.25,this.ct=this.context.createGain(),this.ct.connect(this.context.destination),this.at=this.context.createConvolver(),this.at.connect(this.ct)}async init(){const t=await this.ut();this.at.buffer=t,this.at.connect(this.ct)}async ut(){return new Promise((t=>{const s=this.ot.createGain();s.connect(this.ot.destination),s.gain.setValueAtTime(1,0),s.gain.exponentialRampToValueAtTime(1e-4,2);const e=J(this.ot,"lowpass",5e3,s),i=J(this.ot,"highpass",500,e),n=this.ot.createBufferSource();n.buffer=G(2),n.connect(i),n.start(),this.ot.startRendering(),this.ot.oncomplete=s=>{t(s.renderedBuffer)}}))}}I.lt=196,I.dt=2,I.wt=44100;const Q=class{constructor(){this.yt=[],this.vt=0}ft(t,s){this.vt++;const e=this.vt,i=z.context.createBuffer(1,1,44100),n=z.context.createBufferSource();return n.buffer=i,n.connect(z.context.destination),this.yt.push({id:e,time:t,type:"single",source:n}),n.onended=()=>{s(),this.cancel(e)},n.start(t-i.duration),e}xt(t){t.count++;const s=z.context.createBufferSource();s.buffer=t.source.buffer,s.connect(z.context.destination),s.onended=()=>{t.Mt(),this.xt(t)},s.start(t.time+t.count*t.frequency-s.buffer.duration),t.source=s}gt(t,s,e){const i=z.context.createBuffer(1,1,44100),n=z.context.createBufferSource();n.buffer=i,n.connect(z.context.destination);const h={id:++this.vt,count:0,time:t,frequency:s,type:"repeating",Mt:e,source:n};return n.onended=()=>{e(),this.xt(h)},n.start(Math.max(0,t-i.duration)),this.yt.push(h),h.id}qt(t){return this.yt.find((s=>s.id===t))}clear(){this.yt.forEach((t=>{t.source.onended=null,t.source.stop(),t.source.disconnect()})),this.yt.length=0}cancel(t){const s=this.qt(t);if(s){s.source.onended=null;try{s.source.stop()}catch(t){}s.source.disconnect(),this.yt=this.yt.filter((t=>t.id!==s.id))}}},V=[0,4,5,7,10],z=new I,H=new Q,D=(t,s,e=z.context.currentTime)=>{s&&s.forEach((({value:s,time:i,exp:n=!1})=>{n?t.exponentialRampToValueAtTime(s,e+i):t.linearRampToValueAtTime(s,e+i)}))},K=t=>{let s;return s=t>0?2:.5,196*Math.pow(Math.pow(s,1/12),Math.abs(t))},J=(t=z.context,s,e,i)=>{const n=t.createBiquadFilter();return n.frequency.value=e,n.type=s,i&&n.connect(i),n},G=t=>{const s=44100*t,e=j(s),i=j(s);for(let t=0;t<s;t++)e[t]=1-2*N(),i[t]=1-2*N();const n=z.context.createBuffer(2,s,44100);return n.getChannelData(0).set(e),n.getChannelData(1).set(i),n},W=t=>{const s=A((t.position.x-L.position.x)/7,-1,1),e=A((t.position.y-L.position.y)/7,-1,1),i=Math.sqrt(s**2+e**2);t.bt.pan.pan.value=s,t.bt.Tt(Math.abs(s)),t.bt.Et(1-i)},Z=(t,s=22050)=>{const e=100*t,i=new Float32Array(s),n=Math.PI/180;for(let t=0;t<s;t++){let h=2*t/s-1;i[t]=(3+e)*h*20*n/(Math.PI+e*Math.abs(h))}return i};class _ extends p{constructor(t={}){super(t);const{x:s,y:e,kt:i=!1,id:n=""}=t;this.id=n,this.kt=i,this.position=new m(s,e),this.At=0,this.Ot=c}}class tt extends _{constructor(t){super(t),this.type="instrument",this.color=o}init(){this.Ft=(t=>{let s=0,e=0,i=0,n=0;return t.forEach((t=>{const[h,o]=t;h<s&&(s=h),h>i&&(i=h),o<e&&(e=o),o>n&&(n=o)})),{St:s,$t:i,Bt:e,Rt:n}})(this.outline),this.shape=((t,s,e)=>{const{St:i,$t:n,Bt:h,Rt:o}=e,r=[],c=new Path2D;((t,s)=>{for(let e=0;e<s.length;e++){const[i,n]=s[e];0===e?t.moveTo(i,n):t.lineTo(i,n)}})(c,s);for(let s=i;s<n;s++)for(let e=h;e<o;e++)t.isPointInPath(c,s+.5,e+.5)&&r.push([s,e+1]);return r})(u.X,this.outline,this.Ft),this.Ct=this.Ft.$t-this.Ft.St,this.Pt=this.Ft.Rt-this.Ft.Bt,this.kt||this.Lt(),this.Ut=Math.round(this.Xt/3),W(this)}Yt(){const{J:t,G:s,W:e,Z:i}=L.K,{x:n,y:h}=this.position,o=v(n),r=f(h),c=U[o][r],a=o>t&&o<s&&r>e&&r<i,u=Boolean(c.it),l=c.jt||!1,p=this.shape.some((([t,s])=>U[o+t][r+s].jt||Boolean(U[o+t][r+s].it)));return a&&!u&&!l&&!p}Lt(){this.kt=!1;const t=v(this.position.x),s=f(this.position.y);U[t][s].it=this,this.shape.forEach((([e,i])=>{U[t+e][s+i].jt=!0}))}Nt(){const t=v(this.position.x),s=f(this.position.y);U[t][s]=new Object,this.shape.forEach((([e,i])=>{U[t+e][s+i].jt=!1}));for(let e=t-1;e<=t+1;e++)for(let t=s-1;t<=s+1;t++){const s=U[e][t];if("oscillator"===s?.it?.type){s.it.It()}}}et(t=u.X,s=!0){t.save(),t.fillStyle=this.disabled?c:this.color,t.beginPath();for(let s=0;s<this.outline.length;s++){const[e,i]=this.outline[s],n=x(this.position.x+e),h=M(this.position.y+i);0===s?t.moveTo(n,h):t.lineTo(n,h)}t.closePath(),t.clip();const{St:n,Rt:h}=this.Ft;if(t.fillRect(x(this.position.x+n),M(this.position.y+h),d.width(.06)*this.Ct,d.width(.06)*this.Pt),t.stroke(),s){const s=x(this.position.x+.5),n=M(this.position.y-.5);t.fillStyle=e,t.beginPath(),t.arc(s,n,d.width(.015),0,l),t.fill(),t.fillStyle=i;const h=this.display.substr(0,1),o=t.measureText(h);t.fillText(this.display.substr(0,1),s,n+o.actualBoundingBoxAscent/2)}t.restore()}}class st{constructor(t={}){this.note=t.note,this.Qt=0,this.pan=z.context.createStereoPanner(),this.Vt=z.context.createGain(),this.zt=z.context.createGain(),this.Ht=z.context.createGain(),this.Dt=0,this.Kt={baseVolume:.5,baseReverb:0,lpEnvQ:1.7,hpEnvQ:1.7}}play(t,s=this.Jt()){}Gt(){if(!this.Wt)return!1;let t=!1;for(let s in Object.values(this.Wt)){s.length>0&&(t=!0);break}return t}Zt(){const t=(this.Wt?.filters||[]).map((({_t:t,type:s,frequency:e,gain:i})=>{const n=z.context.createBiquadFilter();return n.type=s,t&&(n.Q.value=t),e&&(n.frequency.value=e),i&&(n.gain.value=i),n})),s=(this.Wt?.ts||[]).map((({threshold:t,attack:s,knee:e,ratio:i,release:n})=>{const h=z.context.createDynamicsCompressor();return h.threshold.value=t,h.attack.value=s,h.knee.value=e,h.ratio.value=i,h.release.value=n,h})),e=[...(this.Wt?.ss||[]).map((({curve:t})=>{const s=z.context.createWaveShaper();return s.curve=t,s})),...t,...s];return e.forEach(((t,s,e)=>{s!==e.length-1&&t.connect(e[s+1])})),e}Tt(t){E(t)||(this.Dt=t),this.Vt.gain.value=1-this.Dt-this.Kt.baseReverb,this.zt.gain.value=this.Kt.baseReverb+this.Dt}Et(t){E(t)||(this.es=t),this.Ht.gain.value=this.Kt.baseVolume*this.es}ns(t,s,e={}){const i=z.context.createGain();D(i.gain,this.hs.amplitude),this.Tt();const n=z.context.createBiquadFilter();n.type="lowpass",n.frequency.value=2e4,n.Q.value=this.os("lpEnvQ",e.lpEnvQ);const h=z.context.createBiquadFilter();h.type="highpass",h.frequency.value=20,h.Q.value=this.os("hpEnvQ",e.hpEnvQ),this.Et(),this.hs?.rs&&D(n.frequency,this.hs.rs),this.hs?.cs&&D(h.frequency,this.hs.cs);const{source:o,gain:r}=s;if(o.connect(r),r.connect(i),i.connect(n),n.connect(h),this.Gt()){const t=this.Zt(),s=t[0],e=t.pop();h.connect(s),e.connect(this.Ht)}else n.connect(this.Ht);this.Ht.connect(this.pan),this.pan.connect(this.Vt),this.pan.connect(this.zt),this.Vt.connect(z.ct),this.zt.connect(z.at),o.start(t),o.stop(t+this.duration),o.onended=()=>{o.disconnect()}}us(t,s,e={}){let i;const n=z.context.createGain(),h=this.Jt(s);if("waveform"===t){const{ls:t}=e;i=z.context.createOscillator(),i.type=t,i.frequency.value=K(h)}if("harmonics"===t){const{ps:t,ls:s}=e;if(i=z.context.createOscillator(),i.type=s,E(t))throw new Error("harmonic option required");n.gain.value=.2/(1+Math.log2(t)),i.frequency.value=K(h)*t}if("waveform"!==t&&"harmonics"!==t||(this.duration=this.hs.amplitude?.map((({time:t})=>t)).reduce(((t,s)=>t+s))||0),"sample"===t){const{buffer:t}=e;i=z.context.createBufferSource(),i.buffer=t,this.duration=t.duration}return{source:i,gain:n,note:s}}os(t,s){return E(s)?this.Kt[t]:s}Jt(t){return E(t)?E(this.note)?this.Qt+V[Math.floor(Math.random()*V.length)]:this.Qt+this.note:this.Qt+t}}class et extends st{constructor(t={}){super(t),this.Qt=-24,this.hs={amplitude:[{time:0,value:1},{time:.75,value:1e-4,exp:!0}]},this.Wt={ss:[{curve:Z(.2)}]},this.Kt.baseVolume=.5}play(t,s){const e=this.us("waveform",s,{ls:"sine"});this.ns(t,e)}}class it extends tt{constructor(t={}){super(t),this.ds="dr",this.display="Kick",this.Xt=50,this.nt=3,this.outline=[[0,0],[1,0],[1,-1],[0,-1]],this.bt=new et({note:0}),this.init()}}class nt extends st{constructor(t={}){super(t),this.Qt=0,this.hs={amplitude:[{time:0,value:0},{time:.015,value:1},{time:.45,value:1e-4,exp:!0}]},this.Wt={filters:[{type:"highpass",frequency:90,_t:1.7}]},this.Kt.baseReverb=.05,this.Kt.baseVolume=.25}play(t,s=this.Jt()){const e=this.us("waveform",s,{ls:"sine"});e.gain.gain.value=.3;const i=this.us("sample",s,{buffer:z.at.buffer});i.gain.gain.value=.5,this.ns(t,e),this.ns(t,i)}}class ht extends tt{constructor(t={}){super(t),this.ds="dr",this.display="Snare",this.Xt=25,this.nt=2,this.outline=[[0,0],[1,0],[1,-1],[0,-1]],this.bt=new nt({note:0}),this.init()}}class ot extends _{constructor(t={}){super(t),this.type="oscillator",this.ws=[]}init(){this.kt||this.Lt(),this.Ut=Math.round(this.Xt/3)}ys(){return z.context.currentTime%this.duration/this.duration}Yt(){const{J:t,G:s,W:e,Z:i}=L.K,{x:n,y:h}=this.position,o=v(n),r=f(h),c=U[o][r],a=o>t&&o<s&&r>e&&r<i,u=Boolean(c.it),l=c.jt||!1;return a&&!u&&!l}Lt(){this.kt=!1,U[v(this.position.x)][f(this.position.y)].it=this,this.ws.forEach((t=>{H.cancel(t)})),this.It()}Nt(){const t=v(this.position.x),s=f(this.position.y);U[t][s]=new Object,this.vs()}et(){const t=x(this.position.x+.5),s=M(this.position.y-.5);this.fs(t,s),this.xs(t,s),this.kt&&(u.U.globalAlpha=.5,this.Ms.forEach((t=>{const[s,e]=t;u.U.beginPath(),$(x(this.position.x+s),M(this.position.y+e),!0,!1,u.U)})),u.U.globalAlpha=1)}xs(t,s){u.U.moveTo(t,s);const e=this.ys();let i,n;for(let t=0;t<this.Ms.length;t++){const s=(t+1)/this.Ms.length;if(e<s){const h=(s-e)*this.Ms.length;i=x(this.position.x+.5+O(this.Ms[t][0],this.Ms[(t+1)%this.Ms.length][0],h)),n=M(this.position.y-.5+O(this.Ms[t][1],this.Ms[(t+1)%this.Ms.length][1],h)),u.U.lineTo(i,n),u.U.stroke(),u.U.beginPath(),u.U.arc(i,n,d.width(.015),0,l),u.U.fill();break}}}fs(t,s){}vs(){this.ws.forEach((t=>{H.cancel(t)}))}It(){this.vs();const t=v(this.position.x),s=f(this.position.y),e=Math.ceil(Math.max(this.ys()||.1)*this.Ms.length),i=(t=>{const s=z.context.currentTime/t;return(Math.floor(s)+1)*t})(this.interval);for(let n=0;n<this.Ms.length;n++){const h=i+n*this.interval,o=(n+e)%this.Ms.length,r=this.Ms[o],c=U[t+r[0]][s+r[1]];this.ws.push(H.gt(h,this.duration,(()=>{if("instrument"===c?.it?.type&&"playing"!==c.state){c.state="playing";const t=c.it,s=t.nt;this.At+=s,P.V+=s,P.H+=s,t.At+=s,t.bt.play(z.context.currentTime),H.ft(z.context.currentTime+.7714285714285714,(()=>{c.state="stopped"}))}})))}}}class rt extends ot{constructor(t={}){super(t)}init(){this.Ms=[[0,this.gs],[this.gs,0],[0,-this.gs],[-this.gs,0]],this.duration=this.interval*this.Ms.length,super.init()}fs(t,s,e=u.U,i=d.width(.048),n=d.width(.006),h=(this.disabled?this.Ot:this.color)){e.strokeStyle=h,e.fillStyle=h,e.lineWidth=n,e.beginPath(),e.arc(t,s,i/2,0,l)}xs(t,s){u.U.moveTo(t,s);const e=((t,s,e,i,n)=>({x:Math.cos(n)*(t-e)-Math.sin(n)*(s-i)+e,y:Math.sin(n)*(t-e)+Math.cos(n)*(s-i)+i}))(t+d.width(.06*this.gs),s,t,s,l*this.ys()-Math.PI/2);u.U.lineTo(e.x,e.y),u.U.stroke(),u.U.beginPath(),u.U.arc(e.x,e.y,d.width(.015),0,l),u.U.fill()}}class ct extends rt{constructor(t={}){super(t),this.display="Circle",this.Xt=25,this.gs=1,this.color=h,this.interval=.8571428571428571,this.init()}}const at={screenX:void 0,screenY:void 0,qs:void 0,bs:void 0},ut=new class{constructor(t,s){this.x=t,this.y=s}}(9,16);let lt=!1,pt=!1;const mt=()=>{"hidden"===a.v.style.visibility?(a.v.style.visibility="visible",a.M.style.transform="rotate(0deg)",lt=!0,yt(),pt&&dt(),L.ht=null,document.addEventListener("mousedown",Mt)):(a.v.style.visibility="hidden",a.M.style.transform="rotate(45deg)",lt=!1,document.removeEventListener("mousedown",Mt))},dt=()=>{"hidden"===a.q.style.visibility?(a.q.style.visibility="visible",pt=!0,wt(),document.addEventListener("mousedown",Mt)):(a.q.style.visibility="hidden",pt=!1,L.Ts=null,document.removeEventListener("mousedown",Mt))},wt=()=>{if(L.Ts){const t=Math.round(L.Ts.Xt/3);a.O.innerHTML=F(L.Ts.Xt),a.A.innerHTML=L.Ts.display,a.F.innerHTML=F(L.Ts.At),a.S.innerHTML=F(t)}},yt=()=>{},vt=()=>{const t=document.querySelectorAll(".hide-intro");t.forEach((t=>{t.style.opacity="1"})),a.B.style.transform="translate(0, -100%)",window.setTimeout((()=>{es(),t.forEach((t=>t.style.transitionDuration="0ms"))}),1e3)},ft=()=>{L.Ts&&(L.Ts.Nt(),P.V+=L.Ts.Ut,P.H+=L.Ts.Ut,dt())},xt=()=>{k(a.o),u.C.fillStyle="white",u.C.strokeStyle="white",X.forEach((([t,s,e,i])=>{u.C.lineWidth=d.width(e),C(u.C,d.N(t),d.I(s),d.width(6*e),i),u.C.fill(),u.C.stroke()})),R(u.C,n,Y[0]),R(u.C,r,Y[1]),(()=>{const t=u.P.createRadialGradient(d.N(0),d.I(0),d.width(.21),d.N(0),d.I(0),d.width(.42));t.addColorStop(0,s),t.addColorStop(.25,s),t.addColorStop(1,i),k(a.u),u.P.lineWidth=d.width(.006),u.P.strokeStyle=e,u.P.fillStyle=t,u.P.beginPath(),u.P.arc(d.N(0),d.I(0),d.width(.42),0,l),u.P.fill(),u.P.stroke()})(),L.tt()},Mt=t=>{!lt||a.v.contains(t.target)||a.M.contains(t.target)||mt(),pt&&!a.T.contains(t.target)&&dt()},gt=t=>{"Escape"===t.key&&lt&&mt()},qt=t=>{"Escape"===t.key&&pt&&dt()},bt=t=>{at.screenX=t.x,at.screenY=t.y,at.qs=g(t.x),at.bs=q(t.y)},Tt=t=>{if(z.context.resume(),!lt&&!pt){const s=.06*a.h.clientWidth;let e=t.clientX,i=t.clientY;const{x:n,y:h}=L.position,o=t=>{const o=t.clientX-e,r=t.clientY-i;L.position.set(n-o/s,h+r/s),L.tt();for(let t=L.K.J;t<=L.K.G;t++)for(let s=L.K.W;s<=L.K.Z;s++){const e=U[t][s]?.it;"instrument"===e?.type&&W(e)}},r=()=>{document.removeEventListener("mousemove",o),document.addEventListener("mousemove",bt)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",r,{once:!0}),document.removeEventListener("mousemove",bt)}},Et=()=>{!L.Ts||pt||L.ht||dt()},kt=()=>{if(lt||pt)return;if(E(at.qs)||E(at.bs))return;const t=v(at.qs),s=f(at.bs);if(E(t)||E(s))return;const e=U[t][s];return L.Ts=e.it,e.it?a.l.style.cursor="pointer":L.ht||(a.l.style.cursor="grab"),e},At=()=>{[a.h,a.o,a.u,a.l,a.p,a.m,a.v,a.q].forEach((t=>{(t=>{const s=t.parentElement;new ResizeObserver((()=>{const{width:e,height:i}=s.getBoundingClientRect(),n=Math.min(e/ut.x,i/ut.y),h=n*ut.x,o=n*ut.y,r=window.devicePixelRatio||1;t.width=h*r,t.height=o*r,t.style.width=h+"px",t.style.height=o+"px",L.tt()})).observe(s)})(t)})),a.start.addEventListener("click",vt),a.M.addEventListener("click",mt),a.k.addEventListener("click",dt),a.$.addEventListener("click",ft),document.addEventListener("keydown",gt),document.addEventListener("keydown",qt),document.addEventListener("mousemove",bt),document.addEventListener("mousemove",kt),document.addEventListener("mousedown",Tt),document.addEventListener("mousedown",Et);new ResizeObserver(xt).observe(a.root)};class Ot extends st{constructor(t={}){super(t),this.Qt=36,this.hs={amplitude:[{time:0,value:1},{time:.2,value:0}]},this.Kt.baseReverb=.25,this.Kt.baseVolume=.09,this.Wt={filters:[{type:"lowpass",frequency:1500,_t:.71},{type:"highpass",frequency:250,_t:1.2}]}}play(t,s){[this.us("waveform",V[0],{ls:"sine"}),this.us("waveform",V[1],{ls:"sine"}),this.us("waveform",V[3],{ls:"sine"}),this.us("waveform",V[4],{ls:"sine"})].forEach(((t,s)=>{window.setTimeout((()=>{this.ns(z.context.currentTime,t)}),.10714285714285714*s*1e3)}))}}class Ft extends tt{constructor(t={}){super(t),this.ds="cs",this.display="Cosmic Ray",this.Xt=5e3,this.nt=75,this.outline=[[0,0],[1,0],[1,1],[2,1],[2,0],[2,-1],[1,-1],[0,-1],[0,-2],[-1,-2],[-1,-1],[-1,0]],this.bt=new Ot,this.init()}}class St extends st{constructor(t){super(t)}play(t,s){this.Es?.forEach((e=>{const i=this.us("harmonics",s,{ls:"sine",ps:e});this.ns(t,i)})),this.ks?.forEach((e=>{const i=this.us("harmonics",s,{ls:"square",ps:e});this.ns(t,i)})),this.As?.forEach((e=>{const i=this.us("harmonics",s,{ls:"sawtooth",ps:e});this.ns(t,i)}))}}class $t extends St{constructor(t={}){super(t),this.As=[0,2,4],this.Qt=-24,this.hs={amplitude:[{time:0,value:0},{time:.5,value:1},{time:.75,value:0}]},this.Kt.baseReverb=.2,this.Kt.baseVolume=.4}}class Bt extends tt{constructor(t={}){super(t),this.ds="cs",this.display="Harmonix",this.Xt=500,this.nt=15,this.outline=[[0,0],[0,1],[1,1],[1,0],[2,0],[3,0],[3,-1],[2,-1],[1,-1],[1,-2],[0,-2],[0,-1],[-1,-1],[-2,-1],[-2,0],[-1,0]],this.bt=new $t,this.init()}}class Rt extends st{constructor(t={}){super(t),this.Qt=0,this.hs={amplitude:[{time:0,value:0},{time:.01,value:1},{time:.25,value:1e-4,exp:!0}]},this.Wt={filters:[{type:"highpass",frequency:350,_t:1.7},{type:"peaking",gain:-12,frequency:8780,_t:.85},{type:"lowpass",frequency:18e3,_t:.59}]},this.Kt.baseVolume=.1}play(t,s){const e=this.us("sample",s,{buffer:z.at.buffer});e.source.detune.value=2400,this.ns(t,e)}}class Ct extends tt{constructor(t={}){super(t),this.ds="dr",this.display="HiHat",this.Xt=5,this.nt=1,this.outline=[[0,0],[1,0],[1,-1],[0,-1]],this.bt=new Rt({note:0}),this.init()}}class Pt extends St{constructor(t={}){super(t),this.Es=[1,2,4,8],this.hs={amplitude:[{time:0,value:0},{time:.05,value:1},{time:.35,value:0}],rs:[{time:.35,value:.001,exp:!0}]},this.Kt.baseReverb=.2,this.Wt={filters:[{type:"lowpass",frequency:2500,_t:.71},{type:"highpass",frequency:120,_t:.71}]}}}class Lt extends tt{constructor(t={}){super(t),this.ds="bs",this.display="Organ",this.Xt=25,this.nt=2,this.outline=[[0,1],[0,0],[0,-1],[1,-1],[2,-1],[2,0],[1,0],[1,1]],this.bt=new Pt,this.init()}}class Ut extends St{constructor(t={}){super(t),this.Qt=-12,this.Es=[0,2,4],this.ks=[1],this.hs={amplitude:[{time:0,value:0},{time:.1,value:1},{time:.5,value:.7},{time:.95,value:1e-4,exp:!1}],rs:[{time:0,value:0},{time:.25,value:3500},{time:1.75,value:1e-4,exp:!0}]},this.Kt.baseReverb=.5,this.Kt.baseVolume=.4,this.Wt={filters:[{type:"lowpass",frequency:1500,_t:.71},{type:"highpass",frequency:150,_t:1.2}]}}}class Xt extends tt{constructor(t={}){super(t),this.ds="cs",this.display="Plutonia",this.Xt=2500,this.nt=25,this.outline=[[0,0],[-1,0],[-1,1],[0,1],[1,1],[1,0],[1,-1],[2,-1],[2,-2],[1,-2],[0,-2],[0,-1]],this.bt=new Ut,this.init()}}class Yt extends St{constructor(t={}){super(t),this.As=[1],this.hs={amplitude:[{time:0,value:0},{time:.01,value:1},{time:.7,value:0}],rs:[{time:0,value:0,exp:!1},{time:.15,value:5e3,exp:!1}]},this.Kt.baseReverb=.4,this.Wt={filters:[{type:"lowpass",frequency:1500,_t:1},{type:"highpass",frequency:120,_t:.71}]}}}class jt extends tt{constructor(t={}){super(t),this.ds="bs",this.display="Saw",this.Xt=50,this.nt=3,this.outline=[[0,0],[1,0],[1,-1],[1,-2],[0,-2],[0,-1],[-1,-1],[-1,0]],this.bt=new Yt,this.init()}}class Nt extends St{constructor(t={}){super(t),this.Es=[1,8,9,12,15],this.hs={amplitude:[{time:0,value:0},{time:.01,value:1},{time:.35,value:0}],rs:[{time:.35,value:.001,exp:!0}]},this.Kt.baseReverb=.2,this.Wt={filters:[{type:"lowpass",frequency:2500,_t:.71},{type:"highpass",frequency:120,_t:.71}]}}}class It extends tt{constructor(t={}){super(t),this.ds="bs",this.display="Sine",this.Xt=75,this.nt=4,this.outline=[[0,0],[0,1],[1,1],[1,0],[1,-1],[0,-1],[-1,-1],[-1,0]],this.bt=new Nt,this.init()}}class Qt extends St{constructor(t={}){super(t),this.Es=[2,4,6],this.ks=[1],this.hs={amplitude:[{time:0,value:0},{time:.01,value:1},{time:.15,value:0}],rs:[{time:.35,value:.001,exp:!0}]},this.Kt.baseReverb=.2,this.Wt={filters:[{type:"lowpass",frequency:1500,_t:.71},{type:"highpass",frequency:120,_t:.71}]}}}class Vt extends tt{constructor(t={}){super(t),this.ds="bs",this.display="Square",this.Xt=100,this.nt=5,this.outline=[[0,0],[1,0],[2,0],[2,-1],[1,-1],[1,-2],[0,-2],[0,-1]],this.bt=new Qt,this.init()}}class zt extends st{constructor(t={}){super(t),this.Qt=-24,this.hs={amplitude:[{time:0,value:0},{time:.1,value:1},{time:.5,value:.7},{time:.95,value:1e-4,exp:!1}]},this.Wt={filters:[{type:"lowpass",frequency:2500,_t:1},{type:"highpass",frequency:90}],ss:[{curve:Z(.5)}]},this.Kt.baseVolume=.25}play(t,s){const e=this.us("waveform",s,{ls:"sine"});this.ns(t,e)}}class Ht extends tt{constructor(t={}){super(t),this.ds="cs",this.display="Thermal Bass",this.Xt=250,this.nt=10,this.outline=[[0,0],[-1,0],[-1,1],[0,1],[1,1],[2,1],[2,0],[2,-1],[2,-2],[1,-2],[0,-2],[-1,-2],[-1,-1],[0,-1]],this.bt=new zt,this.init()}}class Dt extends st{constructor(t={}){super(t),this.Qt=0,this.hs={amplitude:[{time:0,value:1},{time:.25,value:1e-4,exp:!0}]},this.Kt.baseReverb=.05}play(t,s){const e=this.us("waveform",s,{ls:"sine"});e.gain.gain.value=.5,this.ns(t,e)}}class Kt extends tt{constructor(t={}){super(t),this.ds="dr",this.display="Tom",this.Xt=15,this.nt=3,this.outline=[[0,0],[1,0],[1,-1],[0,-1]],this.bt=new Dt,this.init()}}const Jt=[t=>new Ct(t),t=>new Kt(t),t=>new ht(t),t=>new it(t),t=>new Lt(t),t=>new jt(t),t=>new It(t),t=>new Vt(t),t=>new Ht(t),t=>new Bt(t),t=>new Xt(t),t=>new Ft(t)];class Gt extends ot{constructor(t={}){super(t),this.width=1}fs(t,s,e=u.U,i=d.width(.06*this.width-.012),n=d.width(.006),h=(this.disabled?this.Ot:this.color)){e.strokeStyle=h,e.fillStyle=h,e.lineWidth=n,e.beginPath(),e.strokeRect(t-i/2,s-i/2,i,i),e.stroke()}}class Wt extends Gt{constructor(t={}){super(t),this.display="Square",this.interval=.21428571428571427,this.Xt=500,this.color=h,this.Ms=[[0,1],[1,1],[1,0],[1,-1],[0,-1],[-1,-1],[-1,0],[-1,1]],this.duration=this.interval*this.Ms.length,this.init()}}class Zt extends ot{constructor(t={}){super(t),this.width=1}fs(t,s,e=u.U,i=d.width(.06*this.width-.012),n=d.width(.006),h=(this.disabled?this.Ot:this.color)){e.strokeStyle=h,e.fillStyle=h,e.lineWidth=n,e.beginPath(),((t,s,e,i)=>{const n=i*Math.sqrt(3)/2;t.beginPath(),t.moveTo(s,e-n/2),t.lineTo(s+i/2,e+n/2),t.lineTo(s-i/2,e+n/2),t.closePath()})(e,t,s,i),e.stroke()}}class _t extends Zt{constructor(t={}){super(t),this.display="Triangle",this.interval=.5714285714285714,this.Xt=50,this.color=h,this.Ms=[[0,1],[1,-1],[-1,-1]],this.duration=this.interval*this.Ms.length,this.init()}}const ts=[t=>new ct(t),t=>new _t(t),t=>new Wt(t)],ss=(t,s)=>{const{type:e,Xt:i}=t,n=document.getElementById("templates").firstElementChild.cloneNode(!0),h=n.querySelector("button");h.classList.add("entity-button"),h.setAttribute("cost",i.toString());const o=n.querySelector("canvas");n.querySelector("p").innerHTML=t.display;const r=n.querySelectorAll("span");r[0].innerHTML="-"+t.Xt,"instrument"===e&&(r[1].innerHTML="&nbsp;/&nbsp;",r[2].innerHTML="+"+t.nt);const c="instrument"===e?t.ds:"os";document.getElementById(c).append(n),h.onclick=e=>{e.stopPropagation(),mt(),((t,s)=>{let e,i;t.position.set(at.qs,at.bs),L.ht=t,a.l.style.cursor="pointer";const n=()=>{const s=at.qs,e=at.bs;if(void 0!==s&&void 0!==e){t.position.set(s,e);const i=!t.Yt();t.disabled=i,a.l.style.cursor=i?"not-allowed":"pointer"}},h=o=>{const r=Math.abs(o.x-e),c=Math.abs(o.y-i);if(r>5||c>5)document.addEventListener("click",h,{once:!0}),a.l.style.cursor="pointer";else if(!t.disabled){const{x:e,y:i}=t.position;s({x:e,y:i}),P.V-=L.ht.Xt,L.ht=null,document.removeEventListener("mousemove",n),a.l.style.cursor="grab"}};document.addEventListener("keydown",(t=>{"Escape"===t.key&&(L.ht=null,document.removeEventListener("mousemove",n),document.removeEventListener("click",h),a.l.style.cursor="grab")})),document.addEventListener("mousedown",(t=>{a.l.style.cursor="grab",e=t.x,i=t.y})),document.addEventListener("mousemove",n),document.addEventListener("mouseup",h,{once:!0})})(t,s)};new ResizeObserver((()=>{k(o),((t,s)=>{k(t);const e=t.getContext("2d"),i=s.id.substr(0,2);if("oscillator"===s.type&&(s.fs(t.width/2,t.height/2,e,t.width*("co"===i?.075:.3),t.width/15),e.stroke()),"instrument"===s.type){const i=s;t.width=a.m.width,t.height=a.m.height;const n=10/Math.max(i.Ct,i.Pt),{x:h,y:o}=ut;e.save(),e.setTransform(n,0,0,n*o/h,-(n-1)*t.width/2,-(n*o/h-1)*t.height/2),s.et(e,!1),e.restore(),e.scale(1,o/h)}})(o,t)})).observe(h)},es=()=>{let t=0;const s=()=>{L.et(),(lt||pt)&&P.V!==t&&(yt(),wt()),t=P.V,window.requestAnimationFrame(s)};window.requestAnimationFrame(s)};(async()=>{await z.init(),At(),[...ts,...Jt].forEach((t=>{const s=t({kt:!0});ss(s,t)})),yt(),L.tt(),new it({x:1,y:0}),new ht({x:-1,y:0}),new ct({x:0,y:0}),a.start.disabled=!1})(),vt()})();</script></body></html>