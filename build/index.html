<html><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1.01"><title>JS13k 2021</title><body class="full"><div id="root" class="full flex flex-centered fill-absolute"><canvas class="centered" id="canvas-pre"></canvas><canvas class="centered" id="canvas-tiles"></canvas><canvas class="centered" id="canvas-instruments"></canvas><canvas class="centered" id="canvas-oscillators"></canvas><canvas class="centered" id="canvas-post"></canvas><canvas class="centered" id="canvas-stats"></canvas><div class="full centered flex flex-centered" id="menu" style="visibility: hidden;"><div class="full flex flex-col flex-centered" id="menu-col"><h1 id="osh" class="mb-2 mt-2">Oscillators</h1><p class="mb-2">Use oscillators to play instruments</p><div class="mb-5" class="flex flex-centered"><div id="os" class="flex"></div></div><h1 id="inh" class="mb-2">Instruments</h1><p class="mb-2" style="width: 75%">Use instruments to create sounds and collect additional notes</p><div class="full" class="flex flex-centered"><div id="dr" class="flex flex-row flex-centered"><p class="row-label">Drums</p></div><div id="bs" class="flex flex-row flex-centered"><p class="row-label">Basic Synths</p></div><div id="cs" class="flex flex-row flex-centered"><p class="row-label">Complex Synths</p></div></div></div></div><div class="flex centered flex-centered" id="inspect" style="visibility: hidden;"><div id="inner-inspect" class="full flex flex-centered flex-col"><button id="close-inspect">✖</button><h1 class="mb-2" id="inspect-name">Snare</h1><div class="flex flex-centered"><p>Cost:&nbsp;</p><p class="pink" id="inspect-cost">50</p></div><div class="flex flex-centered mb-2"><p>Notes produced:&nbsp;</p><p class="green" id="inspect-notes">50</p></div><button class="flex flex-centered mb-2" id="sell-button"><p>Sell for&nbsp;</p><p class="green" id="inspect-sell">50</p></button></div></div><button class="mb-5" id="menu-button">✖</button></div><div id="templates" class="hidden"><div class="flex flex-col flex-centered m-1"><p></p><button class="entity-button"><canvas class="full"></canvas></button><div class="flex"><span class="item-stats pink"><!-- cost # --> </span><span class="item-stats"><!-- / --> </span><span class="item-stats green"><!-- notes # --></span></div></div></div><script>(()=>{"use strict";var t={28:(t,s,n)=>{n.d(s,{t:()=>o});var e=n(645),i=n.n(e)()((function(t){return t[1]}));i.push([t.id,"* {\n  color: white;\n  text-align: center;\n  padding: 0;\n  margin: 0;\n  font-size: 2vh;\n  font-family: Tahoma, sans-serif;\n  user-select: none;\n  overscroll-behavior: none;\n}\n\nh1 {\n  font-size: 3vh;\n  font-weight: normal;\n}\n\n\nbutton {\n  line-height: 0;\n  border-radius: 50%;\n  cursor: pointer;\n  border: .25vh solid white;\n  width: 7.5vh;\n  height: 7.5vh;\n  background-color: #272838;\n}\n\n:focus {\n  outline: none;\n}\n\n:disabled {\n  filter: brightness(.5) grayscale(.75)\n}\n\n.fill-absolute {\n  position: absolute;\n  top: 0;\n  left: 0;\n  overscroll-behavior: none;\n}\n\n.flex {\n  display: flex\n}\n\n.flex-col {\n  flex-direction: column;\n}\n\n.flex-centered {\n  align-items: center;\n  justify-content: center;\n}\n\n.centered {\n  position: absolute;\n  margin-left: auto;\n  margin-right: auto;\n}\n\n.full {\n  width: 100%;\n  height: 100%;\n}\n\n.full-w {\n  width: 100%;\n}\n\n.full-h {\n  height: 100%;\n}\n\n.pink {\n  color: #ff4c7a;\n}\n\n.green {\n  color: #00e19e;\n}\n\n.row-label {\n  width: 8vh;\n  /* flex-basis: 3vh; */\n}\n\n.hidden {\n  display: none;\n}\n\n.m-1 {\n  margin: 1vh;\n}\n\n.mb-5 {\n  margin-bottom: 5vh;\n}\n\n.mt-2 {\n  margin-top: 2vh;\n}\n\n.mb-2 {\n  margin-bottom: 2vh;\n}\n\n.item-stats {\n  line-height: 2.5vh;\n}\n\n#osh {\n  color: #ff4c7a;\n}\n\n#inh {\n  color: #00e19e;\n}\n\n#menu-button {\n  position: absolute;\n  align-self: flex-end;\n  background: rgba(255, 255, 255, 0.1);\n  transition-duration: 250ms;\n  transform: rotate(45deg);\n}\n\n#canvas-stats {\n  cursor: grab;\n}\n\n#menu, #inner-inspect {\n  background: rgba(0,0,0,.85);\n}\n\n#menu {\n  justify-content: flex-start;\n}\n\n#close-inspect {\n  position: absolute;\n  top: 1vh;\n  left: 1vh;\n  width: 5vh;\n  height: 5vh;\n}\n\n#inner-inspect {\n  position: relative;\n  width: 100%;\n  height: 50%;\n  box-sizing: border-box;\n}\n\n#sell-button {\n  border-radius: 3vh;\n  border: .25vh solid white;\n  padding: 2vh;\n  width: unset;\n  height: unset;\n}",""]);const o=i},645:t=>{t.exports=function(t){var s=[];return s.toString=function(){return this.map((function(s){var n=t(s);return s[2]?"@media ".concat(s[2]," {").concat(n,"}"):n})).join("")},s.i=function(t,n,e){"string"==typeof t&&(t=[[null,t,""]]);var i={};if(e)for(var o=0;o<this.length;o++){var h=this[o][0];null!=h&&(i[h]=!0)}for(var r=0;r<t.length;r++){var c=[].concat(t[r]);e&&i[c[0]]||(n&&(c[2]?c[2]="".concat(n," and ").concat(c[2]):c[2]=n),s.push(c))}},s}},379:t=>{var s=[];function n(t){for(var n=-1,e=0;e<s.length;e++)if(s[e].identifier===t){n=e;break}return n}function e(t,e){for(var o={},h=[],r=0;r<t.length;r++){var c=t[r],a=e.o?c[0]+e.o:c[0],u=o[a]||0,l="".concat(a," ").concat(u);o[a]=u+1;var d=n(l),p={h:c[1],media:c[2],u:c[3]};-1!==d?(s[d].l++,s[d].p(p)):s.push({identifier:l,p:i(p,e),l:1}),h.push(l)}return h}function i(t,s){var n=s.m(s);return n.update(t),function(s){if(s){if(s.h===t.h&&s.media===t.media&&s.u===t.u)return;n.update(t=s)}else n.remove()}}t.exports=function(t,i){var o=e(t=t||[],i=i||{});return function(t){t=t||[];for(var h=0;h<o.length;h++){var r=n(o[h]);s[r].l--}for(var c=e(t,i),a=0;a<o.length;a++){var u=n(o[a]);0===s[u].l&&(s[u].p(),s.splice(u,1))}o=c}}},569:t=>{var s={};t.exports=function(t,n){var e=function(t){if(void 0===s[t]){var n=document.querySelector(t);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(t){n=null}s[t]=n}return s[t]}(t);if(!e)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");e.appendChild(n)}},216:t=>{t.exports=function(t){var s=document.createElement("style");return t.v(s,t.attributes),t.g(s),s}},565:(t,s,n)=>{t.exports=function(t){var s=n.M;s&&t.setAttribute("nonce",s)}},795:t=>{t.exports=function(t){var s=t.k(t);return{update:function(n){!function(t,s,n){var e=n.h,i=n.media,o=n.u;i?t.setAttribute("media",i):t.removeAttribute("media"),o&&"undefined"!=typeof btoa&&(e+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(o))))," */")),s.F(e,t)}(s,t,n)},remove:function(){!function(t){if(null===t.parentNode)return!1;t.parentNode.removeChild(t)}(s)}}}},589:t=>{t.exports=function(t,s){if(s.styleSheet)s.styleSheet.cssText=t;else{for(;s.firstChild;)s.removeChild(s.firstChild);s.appendChild(document.createTextNode(t))}}}},s={};function n(e){var i=s[e];if(void 0!==i)return i.exports;var o=s[e]={id:e,exports:{}};return t[e](o,o.exports,n),o.exports}n.n=t=>{var s=t&&t.O?()=>t.default:()=>t;return n.d(s,{a:s}),s},n.d=(t,s)=>{for(var e in s)n.T(s,e)&&!n.T(t,e)&&Object.defineProperty(t,e,{S:!0,get:s[e]})},n.T=(t,s)=>Object.prototype.hasOwnProperty.call(t,s);var e={};(()=>{n.d(e,{$:()=>_t,A:()=>Wt,B:()=>Gt});var t=n(379),s=n.n(t),i=n(795),o=n.n(i),h=n(569),r=n.n(h),c=n(565),a=n.n(c),u=n(216),l=n.n(u),d=n(589),p=n.n(d),m=n(28),v={};v.F=p(),v.v=a(),v.g=r().bind(null,"head"),v.m=o(),v.k=l();s()(m.t,v);m.t&&m.t.q&&m.t.q;class f{constructor({type:t,C:s=!1}={}){this.type=t,this.C=s}}class w{constructor(t=0,s=0){this.x=t,this.y=s}set(t,s){this.x=t,this.y=s}j(){return this.x+this.y}}const y={root:document.getElementById("root"),L:document.getElementById("canvas-tiles"),R:document.getElementById("canvas-pre"),U:document.getElementById("canvas-post"),P:document.getElementById("canvas-stats"),X:document.getElementById("canvas-oscillators"),Y:document.getElementById("canvas-instruments"),I:document.getElementById("menu"),N:document.getElementById("menu-button"),D:document.getElementById("menu-col"),V:document.getElementById("inspect"),H:document.getElementById("inner-inspect"),J:document.getElementById("close-inspect"),K:document.getElementById("inspect-name"),Z:document.getElementById("inspect-cost"),G:document.getElementById("inspect-notes"),W:document.getElementById("inspect-sell"),_:document.getElementById("sell-button")},x={tt:y.L.getContext("2d"),st:y.U.getContext("2d"),nt:y.U.getContext("2d"),et:y.P.getContext("2d"),it:y.X.getContext("2d"),ot:y.Y.getContext("2d")},b=t=>t-63,g=t=>t-63,M=t=>t+63,k=t=>t+63,E=t=>Wt.width(.5)+(t-_t.position.x)*Wt.width(.06)-Wt.width(.03),F=t=>Wt.height(.5)+(_t.position.y-t)*Wt.width(.06)-Wt.width(.03),O=t=>{const{left:s,right:n}=y.L.getBoundingClientRect();if(!(t<s||t>n)){const n=Wt.width()/Wt.width(.06),e=(t-s)/Wt.width(1,!0),i=-n/2+e*n+_t.position.x;return Math.round(i)}},T=t=>{const{top:s,bottom:n}=y.L.getBoundingClientRect();if(!(t<s||t>n)){const e=Wt.height()/Wt.width(.06),i=(n-t-s)/Wt.height(1,!0),o=-e/2+i*e+_t.position.y;return Math.round(o)}},S=t=>E(b(t)),$=t=>F(g(t)),A=t=>void 0===t,B=t=>{t.width=t.clientWidth*window.devicePixelRatio||1,t.height=t.clientHeight*window.devicePixelRatio||1},q=(t,s,n,e,i)=>({x:Math.cos(i)*(t-n)-Math.sin(i)*(s-e)+n,y:Math.sin(i)*(t-n)+Math.cos(i)*(s-e)+e}),C=(t,s,n)=>t*n+s*(1-n),j=t=>{const s=t/1e6;if(s>1)return s.toFixed(1)+"M";const n=t/1e3;return n>1?n.toFixed(1)+"K":t+""},L="rgba(0,0,0,0)",R="#FFFFFF",U="#272838",P="#ff4c7a",Q="#00e19e",X="#B0C4DE",Y={ht:0,rt:0},z=2*Math.PI,I="Tahoma, sans-serif",N={R:{background:U}},D=(t,s,n=!1,e=!0,i=x.tt)=>{e&&i.strokeRect(t,s,Wt.width(.06),Wt.width(.06)),n&&i.fillRect(t,s,Wt.width(.06),Wt.width(.06))},V=t=>{t.beginPath(),t.arc(Wt.ct(0),Wt.at(0),Wt.width(.48),0,z),t.clip()};const H=t=>new Float32Array(t),J=()=>Math.random();class K{constructor(){this.context=new(window.AudioContext||window.webkitAudioContext)({sampleRate:44100}),this.ut=new(window.OfflineAudioContext||window.webkitOfflineAudioContext)(2,88200,44100),this.lt=this.context.createDynamicsCompressor(),this.lt.threshold.value=-24,this.lt.knee.value=24,this.lt.ratio.value=12,this.lt.attack.value=0,this.lt.release.value=.25,this.dt=this.context.createGain(),this.dt.connect(this.lt),this.lt.connect(this.context.destination),this.vt=this.context.createConvolver(),this.vt.connect(this.dt)}async init(){const t=await this.ft();this.vt.buffer=t,this.vt.connect(this.dt)}async ft(){return new Promise((t=>{const s=this.ut.createGain();s.connect(this.ut.destination),s.gain.setValueAtTime(1,0),s.gain.exponentialRampToValueAtTime(1e-4,2);const n=nt(this.ut,"lowpass",5e3,s),e=nt(this.ut,"highpass",500,n),i=this.ut.createBufferSource();i.buffer=et(2),i.connect(e),i.start(),this.ut.startRendering(),this.ut.oncomplete=s=>{t(s.renderedBuffer)}}))}}K.wt=196,K.yt=2,K.xt=44100;const Z=class{constructor(){this.bt=[],this.gt=0}Mt(t,s){this.gt++;const n=this.gt,e=W.context.createBuffer(1,1,44100),i=W.context.createBufferSource();return i.buffer=e,i.connect(W.context.destination),this.bt.push({id:n,time:t,type:"single",source:i}),i.onended=()=>{s(),this.cancel(n)},i.start(t-e.duration),n}kt(t){t.count++;const s=W.context.createBufferSource();s.buffer=t.source.buffer,s.connect(W.context.destination),s.onended=()=>{t.Et(),this.kt(t)},s.start(t.time+t.count*t.frequency-s.buffer.duration),t.source=s}Ft(t,s,n){const e=W.context.createBuffer(1,1,44100),i=W.context.createBufferSource();i.buffer=e,i.connect(W.context.destination);const o={id:++this.gt,count:0,time:t,frequency:s,type:"repeating",Et:n,source:i};return i.onended=()=>{n(),this.kt(o)},i.start(Math.max(0,t-e.duration)),this.bt.push(o),o.id}Ot(t){return this.bt.find((s=>s.id===t))}clear(){this.bt.forEach((t=>{t.source.onended=null,t.source.stop(),t.source.disconnect()})),this.bt.length=0}cancel(t){const s=this.Ot(t);if(s){s.source.onended=null;try{s.source.stop()}catch(t){}s.source.disconnect(),this.bt=this.bt.filter((t=>t.id!==s.id))}}},G=[0,4,5,7,10],W=new K,_=new Z,tt=(t,s,n)=>{if(n){const e=t.value;t.linearRampToValueAtTime(e,s),n.forEach((({value:n,time:e,exp:i=!1})=>{i?t.exponentialRampToValueAtTime(n,s+e):t.linearRampToValueAtTime(n,s+e)}))}},st=t=>{let s;return s=t>0?2:.5,196*Math.pow(Math.pow(s,1/12),Math.abs(t))},nt=(t=W.context,s,n,e)=>{const i=t.createBiquadFilter();return i.frequency.value=n,i.type=s,e&&i.connect(e),i},et=t=>{const s=44100*t,n=H(s),e=H(s);for(let t=0;t<s;t++)n[t]=1-2*J(),e[t]=1-2*J();const i=W.context.createBuffer(2,s,44100);return i.getChannelData(0).set(n),i.getChannelData(1).set(e),i},it=t=>{t.Tt.pan.positionX.value=t.position.x-_t.position.x,t.Tt.pan.positionY.value=t.position.y-_t.position.y};class ot extends f{constructor(t={}){super(t);const{x:s,y:n,St:e=!1,id:i=""}=t;this.id=i,this.St=e,this.position=new w(s,n),this.$t=0,this.At=X}}class ht extends ot{constructor(t){super(t),this.type="instrument",this.color=Q}init(){this.Bt=(t=>{let s=0,n=0,e=0,i=0;return t.forEach((t=>{const[o,h]=t;o<s&&(s=o),o>e&&(e=o),h<n&&(n=h),h>i&&(i=h)})),{qt:s,Ct:e,jt:n,Lt:i}})(this.outline),this.shape=((t,s,n)=>{const{qt:e,Ct:i,jt:o,Lt:h}=n,r=[],c=new Path2D;((t,s)=>{for(let n=0;n<s.length;n++){const[e,i]=s[n];0===n?t.moveTo(e,i):t.lineTo(e,i)}})(c,s);for(let s=e;s<i;s++)for(let n=o;n<h;n++)t.isPointInPath(c,s+.5,n+.5)&&r.push([s,n+1]);return r})(x.ot,this.outline,this.Bt),this.Rt=this.Bt.Ct-this.Bt.qt,this.Ut=this.Bt.Lt-this.Bt.jt,this.St||this.Pt(),this.Qt=Math.round(this.Xt/3),console.log(this.Tt),it(this)}Yt(){const{zt:t,It:s,Nt:n,Dt:e}=_t.Vt,{x:i,y:o}=this.position,h=M(i),r=k(o),c=Gt[h][r],a=h>t&&h<s&&r>n&&r<e,u=Boolean(c.Ht),l=c.Jt||!1,d=this.shape.some((([t,s])=>Gt[h+t][r+s].Jt||Boolean(Gt[h+t][r+s].Ht)));return a&&!u&&!l&&!d}Pt(){this.St=!1;const t=M(this.position.x),s=k(this.position.y);Gt[t][s].Ht=this,this.shape.forEach((([n,e])=>{Gt[t+n][s+e].Jt=!0}))}Kt(){const t=M(this.position.x),s=k(this.position.y);Gt[t][s]=new Object,this.shape.forEach((([n,e])=>{Gt[t+n][s+e].Jt=!1}));for(let n=t-1;n<=t+1;n++)for(let t=s-1;t<=s+1;t++){const s=Gt[n][t];if("oscillator"===s?.Ht?.type){s.Ht.Zt()}}}Gt(t=x.ot,s=!0){t.save(),t.fillStyle=this.disabled?X:this.color,t.beginPath();for(let s=0;s<this.outline.length;s++){const[n,e]=this.outline[s],i=E(this.position.x+n),o=F(this.position.y+e);0===s?t.moveTo(i,o):t.lineTo(i,o)}t.closePath(),t.clip();const{qt:n,Lt:e}=this.Bt;if(t.fillRect(E(this.position.x+n),F(this.position.y+e),Wt.width(.06)*this.Rt,Wt.width(.06)*this.Ut),t.stroke(),s){const s=E(this.position.x+.5),n=F(this.position.y-.5);t.fillStyle=R,t.beginPath(),t.arc(s,n,Wt.width(.015),0,z),t.fill(),t.fillStyle=U;const e=this.display.substr(0,1),i=t.measureText(e);t.fillText(this.display.substr(0,1),s,n+i.actualBoundingBoxAscent/2)}t.restore()}}class rt{constructor(t={}){this.note=t.note,this.Wt=0,this.pan=W.context.createPanner(),this.pan.panningModel="equalpower",this.pan.distanceModel="linear",this.pan.rolloffFactor=1,this.pan.maxDistance=8,this._t={baseVolume:1,baseReverb:0,lpFrequency:2e4,hpFrequency:20,lpQ:1.7,lpEnvQ:1.7,hpEnvQ:1.7,hpQ:1.7}}play(t,s=this.ts()){}ss(t,s,n={}){s.gain.gain.value*=this._t.baseVolume;const e=W.context.createGain();e.gain.value=.5,tt(e.gain,t,this.ns.amplitude);const i=W.context.createGain();i.gain.value=1-this._t.baseReverb;const o=W.context.createGain();o.gain.value=this._t.baseReverb;const h=W.context.createBiquadFilter();h.type="lowpass",h.frequency.value=2e4,h.Q.value=this.es("lpEnvQ",n.lpEnvQ);const r=W.context.createBiquadFilter();r.type="lowpass",r.frequency.value=this.es("lpFrequency",n.lpFrequency),r.Q.value=this.es("lpQ",n.lpQ);const c=W.context.createBiquadFilter();c.type="highpass",c.frequency.value=20,c.Q.value=this.es("hpEnvQ",n.hpEnvQ);const a=W.context.createBiquadFilter();a.type="highpass",a.frequency.value=this.es("hpFrequency",n.hpFrequency),a.Q.value=this.es("hpQ",n.hpQ),this.ns?.os&&tt(h.frequency,t,this.ns.os),this.ns?.hs&&tt(c.frequency,t,this.ns.hs);const{source:u,gain:l}=s;u.connect(l),l.connect(e),e.connect(h),h.connect(c),c.connect(r),r.connect(a),a.connect(this.pan),this.pan.connect(o),this.pan.connect(i),i.connect(W.dt),o.connect(W.vt),u.start(t),u.stop(t+this.duration),u.onended=()=>{u.disconnect(),e.disconnect()}}rs(t,s,n,e={}){let i;const o=W.context.createGain(),h=this.ts(n);if("waveform"===t){const{cs:t}=e;i=W.context.createOscillator(),i.type=t,i.frequency.value=st(h)}if("harmonics"===t){const{us:t,cs:s}=e;if(i=W.context.createOscillator(),i.type=s,!t)throw new Error("harmonic option required");o.gain.value=.2/(1+Math.log2(t)),i.frequency.value=st(h)*t}if("waveform"!==t&&"harmonics"!==t||(this.duration=this.ns.amplitude?.map((({time:t})=>t)).reduce(((t,s)=>t+s))||0),"sample"===t){const{buffer:t}=e;i=W.context.createBufferSource(),i.buffer=t,this.duration=t.duration}return{source:i,gain:o,note:n}}es(t,s){return A(s)?this._t[t]:s}ts(t){return A(t)?A(this.note)?this.Wt+G[Math.floor(Math.random()*G.length)]:this.Wt+this.note:this.Wt+t}}class ct extends rt{constructor(t={}){super(t),this.Wt=-24,this.ns={amplitude:[{time:0,value:1},{time:.75,value:1e-4,exp:!0}]}}play(t,s){const n=this.rs("waveform",t,s,{cs:"sine"});this.ss(t,n)}}class at extends ht{constructor(t={}){super(t),this.ls="dr",this.display="Kick",this.Xt=50,this.ds=3,this.outline=[[0,0],[1,0],[1,-1],[0,-1]],this.Tt=new ct({note:0}),this.init()}}class ut extends rt{constructor(t={}){super(t),this.Wt=0,this.ns={amplitude:[{time:0,value:1},{time:.45,value:1e-4,exp:!0}]},this._t.hpFrequency=90,this._t.baseReverb=.05,this._t.baseVolume=.25}play(t,s=this.ts()){const n=this.rs("waveform",t,s,{cs:"sine"});n.gain.gain.value=.4;const e=this.rs("sample",t,s,{buffer:W.vt.buffer});e.source.detune.value=100*s,this.ss(t,n),this.ss(t,e)}}class lt extends ht{constructor(t={}){super(t),this.ls="dr",this.display="Snare",this.Xt=25,this.ds=2,this.outline=[[0,0],[1,0],[1,-1],[0,-1]],this.Tt=new ut({note:7}),this.init()}}class dt extends ot{constructor(t={}){super(t),this.type="oscillator",this.ps=[]}init(){this.St||this.Pt(),this.Qt=Math.round(this.Xt/3)}vs(){return W.context.currentTime%this.duration/this.duration}Yt(){const{zt:t,It:s,Nt:n,Dt:e}=_t.Vt,{x:i,y:o}=this.position,h=M(i),r=k(o),c=Gt[h][r],a=h>t&&h<s&&r>n&&r<e,u=Boolean(c.Ht),l=c.Jt||!1;return a&&!u&&!l}Pt(){this.St=!1,Gt[M(this.position.x)][k(this.position.y)].Ht=this,this.ps.forEach((t=>{_.cancel(t)})),this.Zt()}Kt(){const t=M(this.position.x),s=k(this.position.y);Gt[t][s]=new Object,this.fs()}Gt(){const t=E(this.position.x+.5),s=F(this.position.y-.5);this.ws(t,s),this.ys(t,s),this.St&&(x.it.globalAlpha=.5,this.xs.forEach((t=>{const[s,n]=t;x.it.beginPath(),D(E(this.position.x+s),F(this.position.y+n),!0,!1,x.it)})),x.it.globalAlpha=1)}ys(t,s){x.it.moveTo(t,s);const n=this.vs();let e,i;for(let t=0;t<this.xs.length;t++){const s=(t+1)/this.xs.length;if(n<s){const o=(s-n)*this.xs.length;e=E(this.position.x+.5+C(this.xs[t][0],this.xs[(t+1)%this.xs.length][0],o)),i=F(this.position.y-.5+C(this.xs[t][1],this.xs[(t+1)%this.xs.length][1],o)),x.it.lineTo(e,i),x.it.stroke(),x.it.beginPath(),x.it.arc(e,i,Wt.width(.015),0,z),x.it.fill();break}}}ws(t,s){}fs(){this.ps.forEach((t=>{_.cancel(t)}))}Zt(){this.fs();const t=M(this.position.x),s=k(this.position.y),n=Math.ceil(Math.max(this.vs()||.1)*this.xs.length),e=(t=>{const s=W.context.currentTime/t;return(Math.floor(s)+1)*t})(this.interval);for(let i=0;i<this.xs.length;i++){const o=e+i*this.interval,h=(i+n)%this.xs.length,r=this.xs[h],c=Gt[t+r[0]][s+r[1]];this.ps.push(_.Ft(o,this.duration,(()=>{if("instrument"===c?.Ht?.type&&"playing"!==c.state){c.state="playing";const t=c.Ht,s=t.ds;this.$t+=s,Y.ht+=s,Y.rt+=s,t.$t+=s,t.Tt.play(W.context.currentTime),_.Mt(W.context.currentTime+.7714285714285714,(()=>{c.state="stopped"}))}})))}}}class pt extends dt{constructor(t={}){super(t)}init(){this.xs=[[0,this.bs],[this.bs,0],[0,-this.bs],[-this.bs,0]],this.duration=this.interval*this.xs.length,super.init()}ws(t,s,n=x.it,e=Wt.width(.024),i=Wt.width(.006),o=(this.disabled?this.At:this.color)){n.strokeStyle=o,n.fillStyle=o,n.lineWidth=i,n.beginPath(),n.arc(t,s,e,0,z)}ys(t,s){x.it.moveTo(t,s);const n=q(t+Wt.width(.06*this.bs),s,t,s,z*this.vs()-Math.PI/2);x.it.lineTo(n.x,n.y),x.it.stroke(),x.it.beginPath(),x.it.arc(n.x,n.y,Wt.width(.015),0,z),x.it.fill()}}class mt extends pt{constructor(t={}){super(t),this.display="Circle",this.Xt=25,this.bs=1,this.color=P,this.interval=.8571428571428571,this.init()}}const vt={screenX:void 0,screenY:void 0,gs:void 0,Ms:void 0},ft=new class{constructor(t,s){this.x=t,this.y=s}}(9,16);let wt=!1,yt=!1;const xt=()=>{"hidden"===y.I.style.visibility?(y.I.style.visibility="visible",y.N.style.transform="rotate(0deg)",wt=!0,Mt(),yt&&bt(),_t.ks=null,document.addEventListener("mousedown",Ft)):(y.I.style.visibility="hidden",y.N.style.transform="rotate(45deg)",wt=!1,document.removeEventListener("mousedown",Ft))},bt=()=>{"hidden"===y.V.style.visibility?(y.V.style.visibility="visible",yt=!0,gt(),document.addEventListener("mousedown",Ft)):(y.V.style.visibility="hidden",yt=!1,_t.Es=null,document.removeEventListener("mousedown",Ft))},gt=()=>{if(_t.Es){const t=Math.round(_t.Es.Xt/3);y.Z.innerHTML=j(_t.Es.Xt),y.K.innerHTML=_t.Es.display,y.G.innerHTML=j(_t.Es.$t),y.W.innerHTML=j(t)}},Mt=()=>{document.querySelectorAll(".entity-button").forEach((t=>{parseInt(t.getAttribute("cost"))<=Y.ht?t.disabled&&(t.disabled=!1):t.disabled||(t.disabled=!0)}))},kt=()=>{_t.Es&&(_t.Es.Kt(),Y.ht+=_t.Es.Qt,Y.rt+=_t.Es.Qt,bt())},Et=()=>{((t=y.R,s=50,n=300)=>{const e=t.getContext("2d"),i=Math.sqrt((Math.max(t.width,t.height)/2)**2*2),o=i/40,h=i/o,r=o/10,c=t.width/2,a=t.height/2;for(let t=0;t<h;t++){const i=t*o,h=2*Math.PI*i,u=Math.round(h/(4*r));for(let t=0;t<u;t++){const o=t*(z/u),h=o/z+Math.random()/2,{x:l,y:d}=q(c+i,a,c,a,o);e.fillStyle=`hsl(${C(s,n,h%1)}, 30%, 30%)`,e.beginPath(),e.arc(l,d,r,0,z),e.fill()}}})(),(()=>{const t=x.nt.createRadialGradient(Wt.ct(0),Wt.at(0),Wt.width(.24),Wt.ct(0),Wt.at(0),Wt.width(.48));t.addColorStop(0,L),t.addColorStop(.25,L),t.addColorStop(1,U),B(y.U),x.nt.lineWidth=Wt.width(.006),x.nt.strokeStyle=R,x.nt.fillStyle=t,x.nt.beginPath(),x.nt.arc(Wt.ct(0),Wt.at(0),Wt.width(.48),0,z),x.nt.fill(),x.nt.stroke()})(),_t.Fs()},Ft=t=>{!wt||y.I.contains(t.target)||y.N.contains(t.target)||xt(),yt&&!y.H.contains(t.target)&&bt()},Ot=t=>{"Escape"===t.key&&wt&&xt()},Tt=t=>{"Escape"===t.key&&yt&&bt()},St=t=>{vt.screenX=t.x,vt.screenY=t.y,vt.gs=O(t.x),vt.Ms=T(t.y)},$t=t=>{if(W.context.resume(),!wt&&!yt){const s=.06*y.L.clientWidth;let n=t.clientX,e=t.clientY;const{x:i,y:o}=_t.position,h=t=>{const h=t.clientX-n,r=t.clientY-e;_t.position.set(i-h/s,o+r/s),_t.Fs();for(let t=_t.Vt.zt;t<=_t.Vt.It;t++)for(let s=_t.Vt.Nt;s<=_t.Vt.Dt;s++){const n=Gt[t][s]?.Ht;"instrument"===n?.type&&it(n)}},r=()=>{document.removeEventListener("mousemove",h),document.addEventListener("mousemove",St)};document.addEventListener("mousemove",h),document.addEventListener("mouseup",r,{once:!0}),document.removeEventListener("mousemove",St)}};document.addEventListener("mousedown",(t=>{_t.Es&&!yt&&bt()}),{capture:!1}),document.addEventListener("mousemove",(()=>{if(wt||yt)return;if(A(vt.gs)||A(vt.Ms))return;const t=M(vt.gs),s=k(vt.Ms);if(A(t)||A(s))return;const n=Gt[t][s];return _t.Es=n.Ht,n.Ht?y.P.style.cursor="pointer":y.P.style.cursor="grab",n}),{capture:!1});const At=()=>{[y.L,y.R,y.U,y.P,y.X,y.Y,y.I,y.V].forEach((t=>{(t=>{const s=t.parentElement;new ResizeObserver((()=>{const{width:n,height:e}=s.getBoundingClientRect(),i=Math.min(n/ft.x,e/ft.y),o=i*ft.x,h=i*ft.y,r=window.devicePixelRatio||1;t.width=o*r,t.height=h*r,t.style.width=o+"px",t.style.height=h+"px",_t.Fs()})).observe(s)})(t)})),y.N.addEventListener("click",xt),y.J.addEventListener("click",bt),y._.addEventListener("click",kt),document.addEventListener("keydown",Ot),document.addEventListener("keydown",Tt),document.addEventListener("mousemove",St),document.addEventListener("mousedown",$t);new ResizeObserver(Et).observe(y.root)};class Bt extends rt{constructor(t={}){super(t),this.Wt=0,this.ns={amplitude:[{time:0,value:1},{time:.25,value:1e-4,exp:!0}]},this._t.baseReverb=.05}play(t,s){const n=this.rs("sample",t,s,{buffer:W.vt.buffer});n.gain.gain.value=.4,n.source.detune.value=2400,this.ss(t,n)}}class qt extends ht{constructor(t={}){super(t),this.ls="dr",this.display="HiHat",this.Xt=5,this.ds=1,this.outline=[[0,0],[1,0],[1,-1],[0,-1]],this.Tt=new Bt({note:0}),this.init()}}class Ct extends rt{constructor(t){super(t)}play(t,s){this.Os?.forEach((n=>{const e=this.rs("harmonics",t,s,{cs:"sine",us:n});this.ss(t,e)})),this.Ts?.forEach((n=>{const e=this.rs("harmonics",t,s,{cs:"square",us:n});this.ss(t,e)})),this.Ss?.forEach((n=>{const e=this.rs("harmonics",t,s,{cs:"sawtooth",us:n});this.ss(t,e)}))}}class jt extends Ct{constructor(t={}){super(t),this.Os=[1,2,4,8],this.ns={amplitude:[{time:0,value:0},{time:.05,value:1},{time:.35,value:0}],os:[{time:.35,value:.001,exp:!0}]},this._t.baseReverb=.2}}class Lt extends ht{constructor(t={}){super(t),this.ls="bs",this.display="Organ",this.Xt=25,this.ds=2,this.outline=[[0,1],[0,0],[0,-1],[1,-1],[2,-1],[2,0],[1,0],[1,1]],this.Tt=new jt,this.init()}}class Rt extends Ct{constructor(t={}){super(t),this.Ss=[1,3,5],this.ns={amplitude:[{time:0,value:0},{time:.01,value:1},{time:.35,value:0}],os:[{time:.35,value:.001,exp:!0}]},this._t.baseReverb=.2}}class Ut extends ht{constructor(t={}){super(t),this.ls="bs",this.display="Saw",this.Xt=50,this.ds=3,this.outline=[[0,0],[1,0],[1,-1],[1,-2],[0,-2],[0,-1],[-1,-1],[-1,0]],this.Tt=new Rt,this.init()}}class Pt extends Ct{constructor(t={}){super(t),this.Os=[1,8,9,12,15],this.ns={amplitude:[{time:0,value:0},{time:.01,value:1},{time:.35,value:0}],os:[{time:.35,value:.001,exp:!0}]},this._t.baseReverb=.2}}class Qt extends ht{constructor(t={}){super(t),this.ls="bs",this.display="Sine",this.Xt=75,this.ds=4,this.outline=[[0,0],[0,1],[1,1],[1,0],[1,-1],[0,-1],[-1,-1],[-1,0]],this.Tt=new Pt,this.init()}}class Xt extends Ct{constructor(t={}){super(t),this.Os=[2,4,6],this.Ts=[1],this.ns={amplitude:[{time:0,value:0},{time:.01,value:1},{time:.15,value:0}],os:[{time:.35,value:.001,exp:!0}]},this._t.baseReverb=.2,this._t.lpFrequency=1500,this._t.hpFrequency=1e3}}class Yt extends ht{constructor(t={}){super(t),this.ls="bs",this.display="Square",this.Xt=100,this.ds=5,this.outline=[[0,0],[1,0],[2,0],[2,-1],[1,-1],[1,-2],[0,-2],[0,-1]],this.Tt=new Xt,this.init()}}class zt extends rt{constructor(t={}){super(t),this.Wt=0,this.ns={amplitude:[{time:0,value:1},{time:.25,value:1e-4,exp:!0}]},this._t.baseReverb=.05}play(t,s){const n=this.rs("waveform",t,s,{cs:"sine"});this.ss(t,n)}}class It extends ht{constructor(t={}){super(t),this.ls="dr",this.display="Tom",this.Xt=15,this.ds=3,this.outline=[[0,0],[1,0],[1,-1],[0,-1]],this.Tt=new zt({note:0}),this.init()}}const Nt=[t=>new qt(t),t=>new It(t),t=>new lt(t),t=>new at(t),t=>new Lt(t),t=>new Ut(t),t=>new Qt(t),t=>new Yt(t)];class Dt extends dt{constructor(t={}){super(t),this.width=1}ws(t,s,n=x.it,e=Wt.width(.06*this.width-.012),i=Wt.width(.006),o=(this.disabled?this.At:this.color)){n.strokeStyle=o,n.fillStyle=o,n.lineWidth=i,n.beginPath(),n.strokeRect(t-e/2,s-e/2,e,e),n.stroke()}}class Vt extends Dt{constructor(t={}){super(t),this.display="Square",this.interval=.21428571428571427,this.Xt=500,this.color=P,this.xs=[[0,1],[1,1],[1,0],[1,-1],[0,-1],[-1,-1],[-1,0],[-1,1]],this.duration=this.interval*this.xs.length,this.init()}}class Ht extends dt{constructor(t={}){super(t),this.width=1}ws(t,s,n=x.it,e=Wt.width(.06*this.width-.012),i=Wt.width(.006),o=(this.disabled?this.At:this.color)){n.strokeStyle=o,n.fillStyle=o,n.lineWidth=i,n.beginPath(),((t,s,n,e)=>{const i=e*Math.sqrt(3)/2;t.beginPath(),t.moveTo(s,n-i/2),t.lineTo(s+e/2,n+i/2),t.lineTo(s-e/2,n+i/2),t.closePath()})(n,t,s,e),n.stroke()}}class Jt extends Ht{constructor(t={}){super(t),this.display="Triangle",this.interval=.5714285714285714,this.Xt=50,this.color=P,this.xs=[[0,1],[1,-1],[-1,-1]],this.duration=this.interval*this.xs.length,this.init()}}const Kt=[t=>new mt(t),t=>new Jt(t),t=>new Vt(t)],Zt=(t,s)=>{const{type:n,Xt:e}=t,i=document.getElementById("templates").firstElementChild.cloneNode(!0),o=i.querySelector("button");o.classList.add("entity-button"),o.setAttribute("cost",e.toString());const h=i.querySelector("canvas");i.querySelector("p").innerHTML=t.display;const r=i.querySelectorAll("span");r[0].innerHTML="-"+t.Xt,"instrument"===n&&(r[1].innerHTML="&nbsp;/&nbsp;",r[2].innerHTML="+"+t.ds);const c="instrument"===n?t.ls:"os";document.getElementById(c).append(i),o.onclick=n=>{n.stopPropagation(),xt(),((t,s)=>{t.position.set(vt.gs,vt.Ms),_t.ks=t,y.P.style.cursor="pointer";const n=()=>{const s=vt.gs,n=vt.Ms;void 0!==s&&void 0!==n&&(t.position.set(s,n),t.disabled=!t.Yt())},e=()=>{if(t.disabled)document.addEventListener("click",e,{once:!0});else{const{x:e,y:i}=t.position;s({x:e,y:i}),Y.ht-=_t.ks.Xt,_t.ks=null,document.removeEventListener("mousemove",n),y.P.style.cursor="grab"}};document.addEventListener("keydown",(t=>{"Escape"===t.key&&(_t.ks=null,document.removeEventListener("mousemove",n),document.removeEventListener("click",e),y.P.style.cursor="grab")})),document.addEventListener("mousemove",n),document.addEventListener("click",e,{once:!0})})(t,s)};new ResizeObserver((()=>{B(h),((t,s)=>{B(t);const n=t.getContext("2d"),e=s.id.substr(0,2);if("oscillator"===s.type&&(s.ws(t.width/2,t.height/2,n,t.width*("co"===e?.15:.3),t.width/15),n.stroke()),"instrument"===s.type){const e=s;t.width=y.Y.width,t.height=y.Y.height;const i=5/Math.max(e.Rt,e.Ut),{x:o,y:h}=ft;n.save(),n.setTransform(i,0,0,i*h/o,-(i-1)*t.width/2,-(i*h/o-1)*t.height/2),s.Gt(n,!1),n.restore(),n.scale(1,h/o)}})(h,t)})).observe(o)},Gt=Array.from({length:127}).map((()=>Array.from({length:127},Object))),Wt=new class{constructor(t){this.canvas=t}ct(t){return this.canvas.width*((t+1)/2)}at(t){return this.canvas.height*((t+1)/2)}width(t=1,s=!1){return this.canvas.width*t/(s?window.devicePixelRatio:1)}height(t=1,s=!1){return this.canvas.height*t/(s?window.devicePixelRatio:1)}}(y.L),_t=new class extends f{constructor({type:t="camera",coords:s}){super({type:t}),this.coords=s,this.position=new w,this.$s=new w,this.Vt={zt:void 0,It:void 0,Nt:void 0,Dt:void 0},this.As()}As(){const t=Math.round(this.position.x),s=Math.round(this.position.y);this.Vt={zt:Math.max(0,M(t-8)),It:Math.min(126,M(t+8)),Nt:Math.max(0,k(s-8)),Dt:Math.min(126,k(s+8))}}Fs(){this.As(),B(y.L),x.tt.fillStyle=U,x.tt.strokeStyle=R,x.tt.lineWidth=Wt.width(.006),V(x.tt),x.tt.fillRect(0,0,Wt.width(),Wt.height()),_t.Bs(((t,s,n)=>{D(S(s),$(n))}))}Bs(t){for(let s=this.Vt.zt;s<=this.Vt.It;s++)for(let n=this.Vt.Nt;n<=this.Vt.Dt;n++)t(Gt[s][n],s,n)}Gt(){(()=>{B(y.P),x.et.font=`${Wt.width(.10500000000000001)}px ${I}`,x.et.fillStyle=R,x.et.textAlign="center";const t=x.et.measureText("SPACE JAM");x.et.font=`${Wt.width(.10500000000000001)}px ${I}`;const s="Current: "+j(Y.ht);x.et.font=`${Wt.width(.07)}px ${I}`,x.et.fillText(s,Wt.ct(0),Wt.at(-.85)+2*t.actualBoundingBoxAscent);const n=`(x: ${Math.round(_t.position.x)}, y: ${Math.round(_t.position.y)})`;x.et.font=`${Wt.width(.035)}px ${I}`,x.et.fillText(n,Wt.ct(0),Wt.at(-.85)+3*t.actualBoundingBoxAscent)})(),this.Bs(((t,s,n)=>{const{Ht:e,state:i}=t;"instrument"===e?.type&&"playing"===i&&((t,s,n,e,i)=>{const o=s.width(.0165);t.fillStyle=U,t.globalAlpha=1,t.beginPath(),t.arc(n,e,o,0,z),t.fill(),t.globalAlpha=1,t.font=`${s.width(.0175)}px ${I}`,t.textAlign="center",t.fillStyle=R;const h="+"+i,r=t.measureText(h);t.fillText(h,n,e+r.actualBoundingBoxAscent/2)})(x.et,this.coords,E(b(s)+.5),F(g(n)-.5),e.ds)})),B(y.X),x.it.lineCap="round",x.it.lineJoin="round",x.it.lineWidth=Wt.width(.006),V(x.it),_t.Bs((({Ht:t})=>{"oscillator"===t?.type&&t.Gt()})),B(y.Y),x.ot.font=`${Wt.width(.0175)}px ${I}`,x.ot.textAlign="center",x.ot.fillStyle=U,x.ot.strokeStyle=R,x.ot.lineWidth=Wt.width(.006),x.ot.lineJoin="round",V(x.ot),_t.Bs((({Ht:t})=>{"instrument"===t?.type&&t.Gt()})),this.ks?.Gt()}}({coords:Wt}),ts=async()=>{await W.init(),At(),[...Kt,...Nt].forEach((t=>{const s=t({St:!0});Zt(s,t)})),Object.entries(y).forEach((([t,s])=>{Object.assign(s.style,N[t])})),document.body.style.background="black",Mt(),_t.Fs(),new at({x:1,y:0}),new lt({x:-1,y:0}),new mt({x:0,y:0});let t=0;const s=n=>{_t.Gt(),(wt||yt)&&Y.ht!==t&&(Mt(),gt()),t=Y.ht,window.requestAnimationFrame(s)};window.requestAnimationFrame(s)};window.addEventListener("DOMContentLoaded",(()=>{ts()}))})()})();</script></body></html>