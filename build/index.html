<html><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1.01"><title>JS13k 2021</title><body class="full"><div id="root" class="full flex flex-centered fill-absolute"><canvas class="centered" id="canvas-pre"></canvas><canvas class="centered" id="canvas-tiles"></canvas><canvas class="centered" id="canvas-instruments"></canvas><canvas class="centered" id="canvas-oscillators"></canvas><canvas class="centered" id="canvas-post"></canvas><canvas class="centered" id="canvas-stats"></canvas><div class="full centered flex flex-centered" id="menu" style="visibility: hidden;"><div class="full flex flex-col" id="menu-col"><h1 id="osh" class="mb-2 mt-2">Oscillators</h1><p class="mb-2">Use oscillators to play instruments</p><div class="mb-5" class="flex flex-centered"><div id="os"></div></div><h1 id="inh" class="mb-2">Instruments</h1><p class="mb-2">Use instruments to create sounds and collect notes</p><div class="full" class="flex flex-centered"><div id="dr" class="flex flex-row flex-centered"><p>Drums</p></div><div id="bs" class="flex flex-row flex-centered"><p>Basic Synths</p></div><div id="cs" class="flex flex-row flex-centered"><p>Complex Synths</p></div></div></div></div><div class="flex centered flex-centered" id="inspect" style="visibility: hidden;"><div id="inner-inspect" class="full flex flex-centered flex-col"><button id="close-inspect">✖</button><h1 class="mb-2" id="inspect-name">Snare</h1><div class="flex flex-centered"><p>Cost:&nbsp;</p><p class="pink" id="inspect-cost">50</p></div><div class="flex flex-centered mb-2"><p>Notes produced:&nbsp;</p><p class="green" id="inspect-notes">50</p></div><button class="flex flex-centered mb-2" id="sell-button"><p>Sell for&nbsp;</p><p class="green" id="inspect-sell">50</p></button></div></div><button class="mb-5" id="menu-button">✖</button></div><script>(()=>{"use strict";var t={28:(t,s,n)=>{n.d(s,{t:()=>o});var e=n(645),i=n.n(e)()((function(t){return t[1]}));i.push([t.id,"* {\n  color: white;\n  text-align: center;\n  padding: 0;\n  margin: 0;\n  font-size: 2vh;\n  font-family: Tahoma, sans-serif;\n  user-select: none;\n  overscroll-behavior: none;\n}\n\nh1 {\n  font-size: 3vh;\n  font-weight: normal;\n}\n\n\nbutton {\n  line-height: 0;\n  border-radius: 50%;\n  cursor: pointer;\n  border: .25vh solid white;\n  width: 7.5vh;\n  height: 7.5vh;\n  background-color: #272838;\n}\n\n:focus {\n  outline: none;\n}\n\n:disabled {\n  filter: brightness(.5) grayscale(.75)\n}\n\n.fill-absolute {\n  position: absolute;\n  top: 0;\n  left: 0;\n  overscroll-behavior: none;\n}\n\n.flex {\n  display: flex\n}\n\n.flex-col {\n  flex-direction: column;\n}\n\n.flex-centered {\n  align-items: center;\n  justify-content: center;\n}\n\n.centered {\n  position: absolute;\n  margin-left: auto;\n  margin-right: auto;\n}\n\n.full {\n  width: 100%;\n  height: 100%;\n}\n\n.full-w {\n  width: 100%;\n}\n\n.full-h {\n  height: 100%;\n}\n\n.pink {\n  color: #ff4c7a;\n}\n\n.green {\n  color: #00e19e;\n}\n\n.entity-button {\n  margin-left: 1vh;\n}\n\n.mb-5 {\n  margin-bottom: 5vh;\n}\n\n.mt-2 {\n  margin-top: 2vh;\n}\n\n.mb-2 {\n  margin-bottom: 2vh;\n}\n\n#osh {\n  color: #ff4c7a;\n}\n\n#inh {\n  color: #00e19e;\n}\n\n#menu-button {\n  position: absolute;\n  align-self: flex-end;\n  background: rgba(255, 255, 255, 0.1);\n  transition-duration: 250ms;\n  transform: rotate(45deg);\n}\n\n#canvas-stats {\n  cursor: grab;\n}\n\n#menu, #inner-inspect {\n  background: rgba(0,0,0,.85);\n}\n\n#menu {\n  justify-content: flex-start;\n}\n\n#close-inspect {\n  position: absolute;\n  top: 1vh;\n  left: 1vh;\n  width: 5vh;\n  height: 5vh;\n}\n\n#inner-inspect {\n  position: relative;\n  width: 100%;\n  height: 50%;\n  box-sizing: border-box;\n}\n\n#sell-button {\n  border-radius: 3vh;\n  border: .25vh solid white;\n  padding: 2vh;\n  width: unset;\n  height: unset;\n}",""]);const o=i},645:t=>{t.exports=function(t){var s=[];return s.toString=function(){return this.map((function(s){var n=t(s);return s[2]?"@media ".concat(s[2]," {").concat(n,"}"):n})).join("")},s.i=function(t,n,e){"string"==typeof t&&(t=[[null,t,""]]);var i={};if(e)for(var o=0;o<this.length;o++){var r=this[o][0];null!=r&&(i[r]=!0)}for(var h=0;h<t.length;h++){var c=[].concat(t[h]);e&&i[c[0]]||(n&&(c[2]?c[2]="".concat(n," and ").concat(c[2]):c[2]=n),s.push(c))}},s}},379:t=>{var s=[];function n(t){for(var n=-1,e=0;e<s.length;e++)if(s[e].identifier===t){n=e;break}return n}function e(t,e){for(var o={},r=[],h=0;h<t.length;h++){var c=t[h],a=e.o?c[0]+e.o:c[0],u=o[a]||0,l="".concat(a," ").concat(u);o[a]=u+1;var d=n(l),m={h:c[1],media:c[2],u:c[3]};-1!==d?(s[d].l++,s[d].m(m)):s.push({identifier:l,m:i(m,e),l:1}),r.push(l)}return r}function i(t,s){var n=s.p(s);return n.update(t),function(s){if(s){if(s.h===t.h&&s.media===t.media&&s.u===t.u)return;n.update(t=s)}else n.remove()}}t.exports=function(t,i){var o=e(t=t||[],i=i||{});return function(t){t=t||[];for(var r=0;r<o.length;r++){var h=n(o[r]);s[h].l--}for(var c=e(t,i),a=0;a<o.length;a++){var u=n(o[a]);0===s[u].l&&(s[u].m(),s.splice(u,1))}o=c}}},569:t=>{var s={};t.exports=function(t,n){var e=function(t){if(void 0===s[t]){var n=document.querySelector(t);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(t){n=null}s[t]=n}return s[t]}(t);if(!e)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");e.appendChild(n)}},216:t=>{t.exports=function(t){var s=document.createElement("style");return t.v(s,t.attributes),t.g(s),s}},565:(t,s,n)=>{t.exports=function(t){var s=n.M;s&&t.setAttribute("nonce",s)}},795:t=>{t.exports=function(t){var s=t.O(t);return{update:function(n){!function(t,s,n){var e=n.h,i=n.media,o=n.u;i?t.setAttribute("media",i):t.removeAttribute("media"),o&&"undefined"!=typeof btoa&&(e+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(o))))," */")),s.k(e,t)}(s,t,n)},remove:function(){!function(t){if(null===t.parentNode)return!1;t.parentNode.removeChild(t)}(s)}}}},589:t=>{t.exports=function(t,s){if(s.styleSheet)s.styleSheet.cssText=t;else{for(;s.firstChild;)s.removeChild(s.firstChild);s.appendChild(document.createTextNode(t))}}}},s={};function n(e){var i=s[e];if(void 0!==i)return i.exports;var o=s[e]={id:e,exports:{}};return t[e](o,o.exports,n),o.exports}n.n=t=>{var s=t&&t.S?()=>t.default:()=>t;return n.d(s,{a:s}),s},n.d=(t,s)=>{for(var e in s)n.F(s,e)&&!n.F(t,e)&&Object.defineProperty(t,e,{T:!0,get:s[e]})},n.F=(t,s)=>Object.prototype.hasOwnProperty.call(t,s);var e={};(()=>{n.d(e,{$:()=>ts,j:()=>_t,B:()=>Wt});var t=n(379),s=n.n(t),i=n(795),o=n.n(i),r=n(569),h=n.n(r),c=n(565),a=n.n(c),u=n(216),l=n.n(u),d=n(589),m=n.n(d),p=n(28),v={};v.k=m(),v.v=a(),v.g=h().bind(null,"head"),v.p=o(),v.O=l();s()(p.t,v);p.t&&p.t.A&&p.t.A;class f{constructor({name:t="",C:s=!1}={}){this.name=t,this.C=s}}class w{constructor(t=0,s=0){this.x=t,this.y=s}set(t,s){this.x=t,this.y=s}R(){return this.x+this.y}}const x={root:document.getElementById("root"),q:document.getElementById("canvas-tiles"),U:document.getElementById("canvas-pre"),L:document.getElementById("canvas-post"),P:document.getElementById("canvas-stats"),X:document.getElementById("canvas-oscillators"),Y:document.getElementById("canvas-instruments"),N:document.getElementById("menu"),I:document.getElementById("menu-button"),V:document.getElementById("menu-col"),D:document.getElementById("os"),H:document.getElementById("dr"),J:document.getElementById("bs"),K:document.getElementById("cs"),Z:document.getElementById("inspect"),G:document.getElementById("inner-inspect"),W:document.getElementById("close-inspect"),_:document.getElementById("inspect-name"),tt:document.getElementById("inspect-cost"),st:document.getElementById("inspect-notes"),nt:document.getElementById("inspect-sell"),et:document.getElementById("sell-button")},y={it:x.q.getContext("2d"),ot:x.L.getContext("2d"),rt:x.L.getContext("2d"),ht:x.P.getContext("2d"),ct:x.X.getContext("2d"),at:x.Y.getContext("2d")},b=t=>t-63,g=t=>t-63,M=t=>t+63,O=t=>t+63,k=t=>_t.width(.5)+(t-ts.position.x)*_t.width(.07)-_t.width(.035),S=t=>_t.height(.5)+(ts.position.y-t)*_t.width(.07)-_t.width(.035),F=t=>{const{left:s,right:n}=x.q.getBoundingClientRect();if(!(t<s||t>n)){const n=_t.width()/_t.width(.07),e=2*(t-s)/_t.width(),i=-n/2+e*n+ts.position.x;return Math.round(i)}},T=t=>{const{top:s,bottom:n}=x.q.getBoundingClientRect();if(!(t<s||t>n)){const e=_t.height()/_t.width(.07),i=2*(n-t-s)/_t.height(),o=-e/2+i*e+ts.position.y;return Math.round(o)}},$=t=>k(b(t)),E=t=>S(g(t)),j=t=>void 0===t,B=t=>{t.width=t.clientWidth*window.devicePixelRatio||1,t.height=t.clientHeight*window.devicePixelRatio||1},A=(t,s,n,e,i)=>({x:Math.cos(i)*(t-n)-Math.sin(i)*(s-e)+n,y:Math.sin(i)*(t-n)+Math.cos(i)*(s-e)+e}),C=(t,s,n)=>t*n+s*(1-n),R=t=>{const s=t/1e6;if(s>1)return s.toFixed(1)+"M";const n=t/1e3;return n>1?n.toFixed(1)+"K":t+""},q="rgba(0,0,0,0)",U="#FFFFFF",L="#272838",P="#ff4c7a",Q="#00e19e",X="#B0C4DE",Y={ut:0,lt:0},z=2*Math.PI,N="Tahoma, sans-serif",I={U:{background:L}},V=(t,s,n=!1,e=!0,i=y.it)=>{e&&i.strokeRect(t,s,_t.width(.07),_t.width(.07)),n&&i.fillRect(t,s,_t.width(.07),_t.width(.07))},D=t=>{t.beginPath(),t.arc(_t.dt(0),_t.vt(0),_t.width(.07*6),0,z),t.clip()};class H extends f{constructor(t={}){super(t);const{x:s,y:n,ft:e=!1,id:i=""}=t;this.id=i,this.ft=e,this.position=new w(s,n),this.wt=0,this.xt=X}}class J extends H{constructor(t){super(t),this.name="instrument",this.color=Q}init(){this.yt=(t=>{let s=0,n=0,e=0,i=0;return t.forEach((t=>{const[o,r]=t;o<s&&(s=o),o>e&&(e=o),r<n&&(n=r),r>i&&(i=r)})),{bt:s,gt:e,Mt:n,Ot:i}})(this.outline),this.shape=((t,s,n)=>{const{bt:e,gt:i,Mt:o,Ot:r}=n,h=[],c=new Path2D;((t,s)=>{for(let n=0;n<s.length;n++){const[e,i]=s[n];0===n?t.moveTo(e,i):t.lineTo(e,i)}})(c,s);for(let s=e;s<i;s++)for(let n=o;n<r;n++)t.isPointInPath(c,s+.5,n+.5)&&h.push([s,n+1]);return h})(y.at,this.outline,this.yt),this.kt=this.yt.gt-this.yt.bt,this.St=this.yt.Ot-this.yt.Mt,this.ft||this.Ft(),this.Tt=Math.round(this.$t/3)}Et(){const{jt:t,Bt:s,At:n,Ct:e}=ts.Rt,{x:i,y:o}=this.position,r=M(i),h=O(o),c=Wt[r][h],a=r>t&&r<s&&h>n&&h<e,u=Boolean(c.qt),l=c.Ut||!1,d=this.shape.some((([t,s])=>Wt[r+t][h+s].Ut||Boolean(Wt[r+t][h+s].qt)));return a&&!u&&!l&&!d}Ft(){this.ft=!1;const t=M(this.position.x),s=O(this.position.y);Wt[t][s].qt=this,this.shape.forEach((([n,e])=>{Wt[t+n][s+e].Ut=!0}))}Lt(){const t=M(this.position.x),s=O(this.position.y);Wt[t][s]=new Object,this.shape.forEach((([n,e])=>{Wt[t+n][s+e].Ut=!1}))}Pt(t=y.at,s=!0){t.save(),t.fillStyle=this.disabled?X:this.color,t.beginPath();for(let s=0;s<this.outline.length;s++){const[n,e]=this.outline[s],i=k(this.position.x+n),o=S(this.position.y+e);0===s?t.moveTo(i,o):t.lineTo(i,o)}t.closePath(),t.clip(),console.log(this.kt,this.St,this.yt);const{bt:n,Ot:e}=this.yt;if(t.fillRect(k(this.position.x+n),S(this.position.y+e),_t.width(.07)*this.kt,_t.width(.07)*this.St),t.stroke(),s){const s=k(this.position.x+.5),n=S(this.position.y-.5);t.fillStyle=U,t.beginPath(),t.arc(s,n,_t.width(.0175),0,z),t.fill(),t.fillStyle=L;const e=this.display.substr(0,1),i=t.measureText(e);t.fillText(this.display.substr(0,1),s,n+i.actualBoundingBoxAscent/2)}t.restore()}}const K=t=>new Float32Array(t),Z=()=>Math.random(),G=(t,s,n)=>{if(n){const e=t.value;t.linearRampToValueAtTime(e,s),n.forEach((({value:n,time:e,exp:i=!1})=>{i?t.exponentialRampToValueAtTime(n,s+e):t.linearRampToValueAtTime(n,s+e)}))}},W=t=>{let s;return s=t>0?2:.5,ot*Math.pow(Math.pow(s,1/12),Math.abs(t))},_=(t=et.context,s,n,e)=>{const i=t.createBiquadFilter();return i.frequency.value=n,i.type=s,e&&i.connect(e),i};class tt{constructor(){this.context=new(window.AudioContext||window.webkitAudioContext)({sampleRate:44100}),this.Qt=new(window.OfflineAudioContext||window.webkitOfflineAudioContext)(2,88200,44100),this.Xt=this.context.createGain(),this.Xt.connect(this.context.destination),this.Yt=this.context.createConvolver(),this.Yt.connect(this.Xt)}async init(){const t=await this.zt();this.Yt.buffer=t,this.Yt.connect(this.Xt)}async zt(){return new Promise((t=>{const s=this.Qt.createGain();s.connect(this.Qt.destination),s.gain.setValueAtTime(1,0),s.gain.exponentialRampToValueAtTime(1e-4,2);const n=_(this.Qt,"lowpass",5e3,s),e=_(this.Qt,"highpass",500,n),i=this.Qt.createBufferSource();i.buffer=(t=>{const s=44100*t,n=K(s),e=K(s);for(let t=0;t<s;t++)n[t]=1-2*Z(),e[t]=1-2*Z();const i=et.context.createBuffer(2,s,44100);return i.getChannelData(0).set(n),i.getChannelData(1).set(e),i})(2),i.connect(e),i.start(),this.Qt.startRendering(),this.Qt.oncomplete=s=>{t(s.renderedBuffer)}}))}}tt.Nt=196,tt.It=2,tt.Vt=44100;const st=class{constructor(){this.Dt=[],this.Ht=0}Jt(t,s){this.Ht++;const n=this.Ht,e=et.context.createBuffer(1,1,44100),i=et.context.createBufferSource();return i.buffer=e,i.connect(et.context.destination),this.Dt.push({id:n,time:t,type:"single",source:i}),i.onended=()=>{s(),this.cancel(n)},i.start(t-e.duration),n}Kt(t){t.count++;const s=et.context.createBufferSource();s.buffer=t.source.buffer,s.connect(et.context.destination),s.onended=()=>{t.Zt(),this.Kt(t)},s.start(t.time+t.count*t.frequency-s.buffer.duration),t.source=s}Gt(t,s,n){const e=et.context.createBuffer(1,1,44100),i=et.context.createBufferSource();i.buffer=e,i.connect(et.context.destination);const o={id:++this.Ht,count:0,time:t,frequency:s,type:"repeating",Zt:n,source:i};return i.onended=()=>{n(),this.Kt(o)},i.start(Math.max(0,t-e.duration)),this.Dt.push(o),o.id}Wt(t,s){const n=this._t(t);n&&(n.Zt=s,n.source.onended=()=>{s(),this.Kt(n)})}_t(t){return this.Dt.find((s=>s.id===t))}clear(){this.Dt.forEach((t=>{t.source.onended=null,t.source.stop(),t.source.disconnect()})),this.Dt.length=0}cancel(t){const s=this._t(t);if(s){s.source.onended=null;try{s.source.stop()}catch(t){}s.source.disconnect(),this.Dt=this.Dt.filter((t=>t.id!==s.id))}}},nt=[0,4,5,7,10],et=new tt,it=new st,ot=196;class rt{constructor(t={}){this.note=t.note,this.ts=0,this.ss={ns:1,es:0,os:2e4,rs:20,hs:1.7,cs:1.7,us:1.7,ls:1.7}}play(t,s=this.ds()){}ps(t,s,n={}){s.gain.gain.value*=this.ss.ns;const e=et.context.createGain();G(e.gain,t,this.vs.amplitude);const i=et.context.createGain();i.gain.value=1-this.ss.es;const o=et.context.createGain();o.gain.value=this.ss.es;const r=et.context.createBiquadFilter();r.type="lowpass",r.frequency.value=2e4,r.Q.value=this.fs("lpEnvQ",n.cs);const h=et.context.createBiquadFilter();h.type="lowpass",h.frequency.value=this.fs("lpFrequency",n.os),h.Q.value=this.fs("lpQ",n.hs);const c=et.context.createBiquadFilter();c.type="highpass",c.frequency.value=20,c.Q.value=this.fs("hpEnvQ",n.us);const a=et.context.createBiquadFilter();a.type="highpass",a.frequency.value=this.fs("hpFrequency",n.rs),a.Q.value=this.fs("hpQ",n.ls),this.vs?.ws&&G(r.frequency,t,this.vs.ws),this.vs?.xs&&G(c.frequency,t,this.vs.xs);const{source:u,gain:l}=s;u.connect(l),l.connect(e),e.connect(r),r.connect(c),c.connect(h),h.connect(a),a.connect(o),a.connect(i),i.connect(et.Xt),o.connect(et.Yt),u.start(t),u.stop(t+this.duration),u.onended=()=>{u.disconnect(),e.disconnect()}}ys(t,s,n,e={}){let i;const o=et.context.createGain(),r=this.ds(n);if("waveform"===t){const{bs:t}=e;i=et.context.createOscillator(),i.type=t,i.frequency.value=W(r)}if("harmonics"===t){const{gs:t,bs:s}=e;if(i=et.context.createOscillator(),i.type=s,!t)throw new Error("harmonic option required");o.gain.value=.2/(1+Math.log2(t)),i.frequency.value=W(r)*t}if("waveform"!==t&&"harmonics"!==t||(this.duration=this.vs.amplitude?.map((({time:t})=>t)).reduce(((t,s)=>t+s))||0),"sample"===t){const{buffer:t}=e;i=et.context.createBufferSource(),i.buffer=t,this.duration=t.duration}return{source:i,gain:o,note:n}}fs(t,s){return void 0!==s?s:this.ss[t]}ds(t){return void 0!==t?this.ts+t:void 0!==this.note?this.ts+this.note:this.ts+nt[Math.floor(Math.random()*nt.length)]}}class ht extends rt{constructor(t={}){super(t),this.ts=-24,this.vs={amplitude:[{time:0,value:1},{time:.75,value:1e-4,exp:!0}]}}play(t,s){const n=this.ys("waveform",t,s,{bs:"sine"});this.ps(t,n)}}class ct extends J{constructor(t={}){super(t),this.id="in1",this.type="dr",this.display="Kick",this.$t=50,this.Ms=5,this.outline=[[0,0],[1,0],[1,-1],[0,-1]],this.Os=new ht({note:0}),this.init()}}class at extends rt{constructor(t={}){super(t),this.ts=0,this.vs={amplitude:[{time:0,value:1},{time:.45,value:1e-4,exp:!0}]},this.ss.rs=90,this.ss.es=.05,this.ss.ns=.25}play(t,s=this.ds()){const n=this.ys("waveform",t,s,{bs:"sine"});n.gain.gain.value=.4;const e=this.ys("sample",t,s,{buffer:et.Yt.buffer});e.source.detune.value=100*s,this.ps(t,n),this.ps(t,e)}}class ut extends J{constructor(t={}){super(t),this.id="in2",this.type="dr",this.display="Snare",this.$t=25,this.Ms=3,this.outline=[[0,0],[1,0],[1,-1],[0,-1]],this.init(),this.Os=new at({note:7})}}class lt extends rt{constructor(t){super(t)}play(t,s){this.ks?.forEach((n=>{const e=this.ys("harmonics",t,s,{bs:"sine",gs:n});this.ps(t,e)})),this.Ss?.forEach((n=>{const e=this.ys("harmonics",t,s,{bs:"square",gs:n});this.ps(t,e)})),this.Fs?.forEach((n=>{const e=this.ys("harmonics",t,s,{bs:"sawtooth",gs:n});this.ps(t,e)}))}}class dt extends lt{constructor(t={}){super(t),this.ks=[2,4,6],this.Ss=[1],this.vs={amplitude:[{time:0,value:0},{time:.01,value:1},{time:.15,value:0}],ws:[{time:.35,value:.001,exp:!0}]},this.ss.es=.2,this.ss.os=1500,this.ss.rs=1e3}}class mt extends J{constructor(t={}){super(t),this.id="in8",this.type="bs",this.display="Square Synth",this.$t=15,this.Ms=2,this.outline=[[0,0],[1,0],[2,0],[2,-1],[1,-1],[1,-2],[0,-2],[0,-1]],this.Os=new dt,this.init()}}class pt extends H{constructor(t={}){super(t),this.name="oscillator",this.Ts=[]}init(){this.ft||this.Ft(),this.Tt=Math.round(this.$t/3)}$s(){return et.context.currentTime%this.duration/this.duration}Et(){const{jt:t,Bt:s,At:n,Ct:e}=ts.Rt,{x:i,y:o}=this.position,r=M(i),h=O(o),c=Wt[r][h],a=r>t&&r<s&&h>n&&h<e,u=Boolean(c.qt),l=c.Ut||!1;return a&&!u&&!l}Ft(){this.ft=!1,Wt[M(this.position.x)][O(this.position.y)].qt=this,this.Ts.forEach((t=>{it.cancel(t)})),this.Es()}Lt(){const t=M(this.position.x),s=O(this.position.y);Wt[t][s]=new Object,this.Ts.forEach((t=>{it.cancel(t)}))}Pt(){const t=k(this.position.x+.5),s=S(this.position.y-.5);this.js(t,s),this.Bs(t,s),this.ft&&(y.ct.globalAlpha=.5,this.As.forEach((t=>{const[s,n]=t;y.ct.beginPath(),V(k(this.position.x+s),S(this.position.y+n),!0,!1,y.ct)})),y.ct.globalAlpha=1)}Bs(t,s){y.ct.moveTo(t,s);const n=this.$s();let e,i;for(let t=0;t<this.As.length;t++){const s=(t+1)/this.As.length;if(n<s){const o=(s-n)*this.As.length;e=k(this.position.x+.5+C(this.As[t][0],this.As[(t+1)%this.As.length][0],o)),i=S(this.position.y-.5+C(this.As[t][1],this.As[(t+1)%this.As.length][1],o)),y.ct.lineTo(e,i),y.ct.stroke(),y.ct.beginPath(),y.ct.arc(e,i,_t.width(.0175),0,z),y.ct.fill();break}}}js(t,s){}Es(){const t=M(this.position.x),s=O(this.position.y),n=Math.ceil(Math.max(this.$s()||.1)*this.As.length),e=(t=>{const s=et.context.currentTime/t;return(Math.floor(s)+1)*t})(this.interval);for(let i=0;i<this.As.length;i++){const o=e+i*this.interval,r=(i+n)%this.As.length,h=this.As[r],c=Wt[t+h[0]][s+h[1]];this.Ts.push(it.Gt(o,this.duration,(()=>{if("instrument"===c?.qt?.name&&"playing"!==c.state){c.state="playing";const t=c.qt,s=t.Ms;this.wt+=s,Y.ut+=s,Y.lt+=s,t.wt+=s,c.qt.Os.play(et.context.currentTime),it.Jt(et.context.currentTime+.7714285714285714,(()=>{c.state="stopped"}))}})))}}}class vt extends pt{constructor(t={}){super(t)}init(){this.As=[[0,this.Cs],[this.Cs,0],[0,-this.Cs],[-this.Cs,0]],this.duration=this.interval*this.As.length,super.init()}js(t,s,n=y.ct,e=_t.width(.035-.006),i=_t.width(.006),o=(this.disabled?this.xt:this.color)){n.strokeStyle=o,n.fillStyle=o,n.lineWidth=i,n.beginPath(),n.arc(t,s,e,0,z)}Bs(t,s){y.ct.moveTo(t,s);const n=A(t+_t.width(.07*this.Cs),s,t,s,z*this.$s()-Math.PI/2);y.ct.lineTo(n.x,n.y),y.ct.stroke(),y.ct.beginPath(),y.ct.arc(n.x,n.y,_t.width(.0175),0,z),y.ct.fill()}}class ft extends vt{constructor(t={}){super(t),this.display="Circle Oscillator",this.id="co1",this.$t=25,this.Cs=1,this.color=P,this.interval=.8571428571428571,this.init()}}const wt={screenX:void 0,screenY:void 0,Rs:void 0,qs:void 0},xt=new class{constructor(t,s){this.x=t,this.y=s}}(9,16);class yt extends rt{constructor(t={}){super(t),this.ts=0,this.vs={amplitude:[{time:0,value:1},{time:.25,value:1e-4,exp:!0}]},this.ss.es=.05}play(t,s){const n=this.ys("sample",t,s,{buffer:et.Yt.buffer});n.gain.gain.value=.4,n.source.detune.value=2400,this.ps(t,n)}}class bt extends J{constructor(t={}){super(t),this.id="in3",this.type="dr",this.display="HiHat",this.$t=5,this.Ms=1,this.outline=[[0,0],[1,0],[1,-1],[0,-1]],this.Os=new yt({note:0}),this.init()}}class gt extends lt{constructor(t={}){super(t),this.ks=[1,2,4,8],this.vs={amplitude:[{time:0,value:0},{time:.05,value:1},{time:.35,value:0}],ws:[{time:.35,value:.001,exp:!0}]},this.ss.es=.2}}class Mt extends J{constructor(t={}){super(t),this.id="in5",this.type="bs",this.display="Organ Synth",this.$t=15,this.Ms=2,this.outline=[[0,1],[0,0],[0,-1],[1,-1],[2,-1],[2,0],[1,0],[1,1]],this.Os=new gt,this.init()}}class Ot extends lt{constructor(t={}){super(t),this.Fs=[1,3,5],this.vs={amplitude:[{time:0,value:0},{time:.01,value:1},{time:.35,value:0}],ws:[{time:.35,value:.001,exp:!0}]},this.ss.es=.2}}class kt extends J{constructor(t={}){super(t),this.id="in6",this.type="bs",this.display="Saw Synth",this.$t=15,this.Ms=2,this.outline=[[0,0],[1,0],[1,-1],[1,-2],[0,-2],[0,-1],[-1,-1],[-1,0]],this.Os=new Ot,this.init()}}class St extends lt{constructor(t={}){super(t),this.ks=[1,8,9,12,15],this.vs={amplitude:[{time:0,value:0},{time:.01,value:1},{time:.35,value:0}],ws:[{time:.35,value:.001,exp:!0}]},this.ss.es=.2}}class Ft extends J{constructor(t={}){super(t),this.id="in7",this.type="bs",this.display="Sine Synth",this.$t=15,this.Ms=2,this.outline=[[0,0],[0,1],[1,1],[1,0],[1,-1],[0,-1],[-1,-1],[-1,0]],this.Os=new St,this.init()}}class Tt extends rt{constructor(t={}){super(t),this.ts=0,this.vs={amplitude:[{time:0,value:1},{time:.25,value:1e-4,exp:!0}]},this.ss.es=.05}play(t,s){const n=this.ys("waveform",t,s,{bs:"sine"});this.ps(t,n)}}class $t extends J{constructor(t={}){super(t),this.id="in4",this.type="dr",this.display="Tom",this.$t=15,this.Ms=3,this.outline=[[0,0],[1,0],[1,-1],[0,-1]],this.Os=new Tt({note:0}),this.init()}}const Et={in1:t=>new ct(t),in2:t=>new ut(t),Us:t=>new bt(t),Ls:t=>new $t(t),Ps:t=>new Mt(t),Qs:t=>new kt(t),Xs:t=>new Ft(t),Ys:t=>new mt(t)},jt=Object.values(Et).map((t=>t({ft:!0})));class Bt extends pt{constructor(t={}){super(t),this.width=1}js(t,s,n=y.ct,e=_t.width(.07*this.width-.012),i=_t.width(.006),o=(this.disabled?this.xt:this.color)){n.strokeStyle=o,n.fillStyle=o,n.lineWidth=i,n.beginPath(),n.strokeRect(t-e/2,s-e/2,e,e),n.stroke()}}class At extends Bt{constructor(t={}){super(t),this.display="Square Oscillator",this.interval=.21428571428571427,this.id="so1",this.$t=1e3,this.color=P,this.As=[[0,1],[1,1],[1,0],[1,-1],[0,-1],[-1,-1],[-1,0],[-1,1]],this.duration=this.interval*this.As.length,this.init()}}class Ct extends pt{constructor(t={}){super(t),this.width=1}js(t,s,n=y.ct,e=_t.width(.07*this.width-.012),i=_t.width(.006),o=(this.disabled?this.xt:this.color)){n.strokeStyle=o,n.fillStyle=o,n.lineWidth=i,n.beginPath(),((t,s,n,e)=>{const i=e*Math.sqrt(3)/2;t.beginPath(),t.moveTo(s,n-i/2),t.lineTo(s+e/2,n+i/2),t.lineTo(s-e/2,n+i/2),t.closePath()})(n,t,s,e),n.stroke()}}class Rt extends Ct{constructor(t={}){super(t),this.display="Triangle Oscillator",this.interval=.5714285714285714,this.id="to1",this.$t=50,this.color=P,this.As=[[0,1],[1,-1],[-1,-1]],this.duration=this.interval*this.As.length,this.init()}}const qt={zs:t=>new ft(t),Ns:t=>new Rt(t),Is:t=>new At(t)},Ut=Object.values(qt).map((t=>t({ft:!0})));let Lt=!1,Pt=!1;const Qt=()=>{"hidden"===x.N.style.visibility?(x.N.style.visibility="visible",x.I.style.transform="rotate(0deg)",Lt=!0,zt(),Pt&&Xt(),document.addEventListener("mousedown",Vt)):(x.N.style.visibility="hidden",x.I.style.transform="rotate(45deg)",Lt=!1,document.removeEventListener("mousedown",Vt))},Xt=()=>{"hidden"===x.Z.style.visibility?(x.Z.style.visibility="visible",Pt=!0,Yt(),document.addEventListener("mousedown",Vt)):(x.Z.style.visibility="hidden",Pt=!1,ts.Vs=null,document.removeEventListener("mousedown",Vt))},Yt=()=>{if(ts.Vs){const t=Math.round(ts.Vs.$t/3);x.tt.innerHTML=R(ts.Vs.$t),x._.innerHTML=ts.Vs.display,x.st.innerHTML=R(ts.Vs.wt),x.nt.innerHTML=R(t)}},zt=()=>{},Nt=()=>{ts.Vs&&(ts.Vs.Lt(),Y.ut+=ts.Vs.Tt,Y.lt+=ts.Vs.Tt,Xt())},It=()=>{((t=x.U,s=50,n=300)=>{const e=t.getContext("2d"),i=Math.sqrt((Math.max(t.width,t.height)/2)**2*2),o=i/150,r=i/o,h=o/5,c=t.width/2,a=t.height/2;console.log(t);for(let t=0;t<r;t++){const i=t*o,r=2*Math.PI*i,u=Math.round(r/(4*h));for(let t=0;t<u;t++){const o=t*(z/u),r=o/z+Math.random()/2,{x:l,y:d}=A(c+i,a,c,a,o);e.fillStyle=`hsl(${C(s,n,r%1)}, 50%, 50%)`,e.beginPath(),e.arc(l,d,h,0,z),e.fill()}}})(),(()=>{const t=y.rt.createRadialGradient(_t.dt(0),_t.vt(0),_t.width(3*.07),_t.dt(0),_t.vt(0),_t.width(6*.07));t.addColorStop(0,q),t.addColorStop(.25,q),t.addColorStop(1,L),B(x.L),y.rt.lineWidth=_t.width(.006),y.rt.strokeStyle=U,y.rt.fillStyle=t,y.rt.beginPath(),y.rt.arc(_t.dt(0),_t.vt(0),_t.width(.07*6),0,z),y.rt.fill(),y.rt.stroke()})(),ts.Ds()},Vt=t=>{!Lt||x.N.contains(t.target)||x.I.contains(t.target)||Qt(),Pt&&!x.G.contains(t.target)&&Xt()},Dt=t=>{"Escape"===t.key&&Lt&&Qt()},Ht=t=>{"Escape"===t.key&&Pt&&Xt()},Jt=t=>{wt.screenX=t.x,wt.screenY=t.y,wt.Rs=F(t.x),wt.qs=T(t.y)},Kt=t=>{if(et.context.resume(),!Lt&&!Pt){const s=.07*x.q.clientWidth;let n=t.clientX,e=t.clientY;const{x:i,y:o}=ts.position,r=t=>{const r=t.clientX-n,h=t.clientY-e;ts.position.set(i-r/s,o+h/s),ts.Ds()},h=()=>{document.removeEventListener("mousemove",r),document.addEventListener("mousemove",Jt)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",h,{once:!0}),document.removeEventListener("mousemove",Jt)}};document.addEventListener("mousedown",(t=>{ts.Vs&&!Pt&&Xt()}),{capture:!1}),document.addEventListener("mousemove",(()=>{if(Lt||Pt)return;if(j(wt.Rs)||j(wt.qs))return;const t=M(wt.Rs),s=O(wt.qs);if(j(t)||j(s))return;const n=Wt[t][s];return ts.Vs=n.qt,n.qt?x.P.style.cursor="pointer":x.P.style.cursor="grab",n}),{capture:!1});const Zt=()=>{[x.q,x.U,x.L,x.P,x.X,x.Y,x.N,x.Z].forEach((t=>{(t=>{const s=t.parentElement;new ResizeObserver((()=>{const{width:n,height:e}=s.getBoundingClientRect(),i=Math.min(n/xt.x,e/xt.y),o=i*xt.x,r=i*xt.y,h=window.devicePixelRatio||1;t.width=o*h,t.height=r*h,t.style.width=o+"px",t.style.height=r+"px",ts.Ds()})).observe(s)})(t)})),x.I.addEventListener("click",Qt),x.W.addEventListener("click",Xt),x.et.addEventListener("click",Nt),document.addEventListener("keydown",Dt),document.addEventListener("keydown",Ht),document.addEventListener("mousemove",Jt),document.addEventListener("mousedown",Kt);new ResizeObserver(It).observe(x.root)},Gt=()=>{const t=[...Ut,...jt];t.forEach(((s,n)=>{const e=s.id,i=s.name,o=document.createElement("button"),r=document.createElement("canvas");r.classList.add("full"),o.classList.add("entity-button"),o.append(r),o.id=e;const h="instrument"===i?s.type:"os";console.log(h),x[h].append(o),o.onclick=s=>{s.stopPropagation(),Qt(),((t,s)=>{t.position.set(wt.Rs,wt.qs),ts.Hs=t,x.P.style.cursor="pointer";const n=()=>{const s=wt.Rs,n=wt.qs;void 0!==s&&void 0!==n&&(t.position.set(s,n),t.disabled=!t.Et())},e=()=>{if(t.disabled)document.addEventListener("click",e,{once:!0});else{const{x:e,y:i}=t.position;s({x:e,y:i}),ts.Hs=null,document.removeEventListener("mousemove",n),x.P.style.cursor="grab"}};document.addEventListener("keydown",(t=>{"Escape"===t.key&&(ts.Hs=null,document.removeEventListener("mousemove",n),document.removeEventListener("click",e),x.P.style.cursor="grab")})),document.addEventListener("mousemove",n),document.addEventListener("click",e,{once:!0})})(t[n],"instrument"===i?Et[e]:qt[e])};new ResizeObserver((()=>{B(r),((t,s)=>{B(t);const n=t.getContext("2d"),e=s.id.substr(0,2);if("oscillator"===s.name&&(s.js(t.width/2,t.height/1.75,n,t.width*("co"===e?.15:.3),t.width/15),n.stroke()),"instrument"===s.name){const e=s;t.width=x.Y.width,t.height=x.Y.height;const i=5/Math.max(e.kt,e.St),{x:o,y:r}=xt;n.save(),n.setTransform(i,0,0,i*r/o,-(i-1)*t.width/2,-(i*r/o-1)*t.height/2),s.Pt(n,!1),n.restore(),n.scale(1,r/o)}n.font=`${t.width/5}px ${N}`,n.fillStyle=U,n.textAlign="center";const i=R(s.$t),o=n.measureText(i);n.fillText(i,t.width/2,1.75*o.actualBoundingBoxAscent)})(r,s)})).observe(o)}))},Wt=Array.from({length:127}).map((()=>Array.from({length:127},Object))),_t=new class{constructor(t){this.canvas=t}dt(t){return this.canvas.width*((t+1)/2)}vt(t){return this.canvas.height*((t+1)/2)}width(t=1){return this.canvas.width*t}height(t=1){return this.canvas.height*t}}(x.q),ts=new class extends f{constructor({name:t="camera",coords:s}){super({name:t}),this.coords=s,this.position=new w,this.Js=new w,this.Rt={jt:void 0,Bt:void 0,At:void 0,Ct:void 0},this.Ks()}Ks(){const t=Math.round(this.position.x),s=Math.round(this.position.y);this.Rt={jt:Math.max(0,M(t-6)),Bt:Math.min(126,M(t+6)),At:Math.max(0,O(s-6)),Ct:Math.min(126,O(s+6))}}Ds(){console.log("viewports"),this.Ks(),B(x.q),y.it.fillStyle=L,y.it.strokeStyle=U,y.it.lineWidth=_t.width(.006),D(y.it),y.it.fillRect(0,0,_t.width(),_t.height()),ts.Zs(((t,s,n)=>{V($(s),E(n))}))}Zs(t){for(let s=this.Rt.jt;s<=this.Rt.Bt;s++)for(let n=this.Rt.At;n<=this.Rt.Ct;n++)t(Wt[s][n],s,n)}Pt(){(()=>{B(x.P),y.ht.font=`${_t.width(.10500000000000001)}px ${N}`,y.ht.fillStyle=U,y.ht.textAlign="center";const t=y.ht.measureText("SPACE JAM");y.ht.font=`${_t.width(.10500000000000001)}px ${N}`;const s="Current: "+R(Y.ut);y.ht.font=`${_t.width(.07)}px ${N}`,y.ht.fillText(s,_t.dt(0),_t.vt(-.85)+2*t.actualBoundingBoxAscent);const n=`(x: ${Math.round(ts.position.x)}, y: ${Math.round(ts.position.y)})`;y.ht.font=`${_t.width(.035)}px ${N}`,y.ht.fillText(n,_t.dt(0),_t.vt(-.85)+3*t.actualBoundingBoxAscent)})(),this.Zs(((t,s,n)=>{const{qt:e,state:i}=t;"instrument"===e?.name&&"playing"===i&&((t,s,n,e,i)=>{const o=s.width(.0175*1.1);t.fillStyle=L,t.globalAlpha=1,t.beginPath(),t.arc(n,e,o,0,z),t.fill(),t.globalAlpha=1,t.font=`${s.width(.0175)}px ${N}`,t.textAlign="center",t.fillStyle=U;const r="+"+i,h=t.measureText(r);t.fillText(r,n,e+h.actualBoundingBoxAscent/2)})(y.ht,this.coords,k(b(s)+.5),S(g(n)-.5),e.Ms)})),B(x.X),y.ct.lineCap="round",y.ct.lineJoin="round",y.ct.lineWidth=_t.width(.006),D(y.ct),ts.Zs((({qt:t})=>{"oscillator"===t?.name&&t.Pt()})),B(x.Y),y.at.font=`${_t.width(.0175)}px ${N}`,y.at.textAlign="center",y.at.fillStyle=L,y.at.strokeStyle=U,y.at.lineWidth=_t.width(.006),y.at.lineJoin="round",D(y.at),ts.Zs((({qt:t})=>{"instrument"===t?.name&&t.Pt()})),this.Hs?.Pt()}}({coords:_t});(async()=>{await et.init(),Zt(),Gt(),Object.entries(x).forEach((([t,s])=>{Object.assign(s.style,I[t])})),document.body.style.background="black",zt(),ts.Ds(),new ct({x:1,y:0}),new ut({x:-1,y:0}),new mt({x:-2,y:-2}),new ft({x:0,y:0});let t=0;const s=n=>{ts.Pt(),(Lt||Pt)&&Y.ut!==t&&(zt(),Yt()),t=Y.ut,window.requestAnimationFrame(s)};window.requestAnimationFrame(s)})()})()})();</script></body></html>